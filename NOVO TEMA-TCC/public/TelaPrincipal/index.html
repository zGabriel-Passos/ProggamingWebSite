<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="icon_512x512.png">
    <link rel="icon" type="image/png" href="icon_512x512.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Proggaming | Home</title>
</head>

<body>
    <div class="overlay">
        <img src="../logo_rotating.gif">
    </div>
    <main>
        <div id="avatar-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-button">&times;</span>

                <div class="modal-section">
                    <h2>Escolha seu Avatar</h2>
                    <div id="avatar-list" class="avatar-list">
                    </div>
                    <button id="save-avatar-button">Salvar Avatar</button>
                </div>

                <div class="divider"></div>

                <div class="modal-section">
                    <h2>Alterar Apelido</h2>
                    <p style="font-size: 14px; margin-top: 20px;">
                        <label for="novoUsername" style="margin-top: 15px; display:block;">Novo Apelido:</label>
                        <input type="text" maxlength="25" id="novoUsername" placeholder="Digite o novo apelido"
                            style="padding:5px; margin-top:5px; width: 60%; border: 2px solid #fffff019;">
                    </p>
                    <button id="btnAlterarUsername" style="margin-top:10px; padding:5px 10px;"
                        class="salvar-username">Salvar Apelido</button>
                    <p id="mensagemUsername" style="margin-top:5px; font-size:13px; color:green;"></p>
                </div>
            </div>
        </div>
        <div class="esquerda">
            <div class="menu">
                <div class="logo">
                    <img src="../logo-menor-removebg-preview.png">
                </div>
                <hr>
                <a href="#/In√≠cio" onclick="mostrarSecao('home')"><span>In√≠cio</span> <i class='bx bx-home'></i></a>
                <a href="#/menu.html" onclick="carregarPagina('menu.html')"><span>Aprender</span><i
                        class='bx bx-book-open'></i></a>
                <a href="../Amigos/" target="_blank"><span>Amigos</span><i class='bx bx-user-plus'></i></a>
                <a href="#/Configura√ß√µes" onclick="carregarPagina('configuracoes.html')"><span>Configura√ß√µes</span><i
                        class='bx bx-cog'></i></a>
            </div>
            <div class="perfil">
                <button id="logoutBtn">Sair<i class='bx bx-log-in'></i></button>
            </div>
        </div>

        <div class="direita">
            <div class="header">
                <div class="shine-text">
                    <h2>PROGGAMING <span>- Home</span></h2>
                </div>
                <div class="midias">
                    <a href="https://www.youtube.com/@ProggamingPage" target="_blank"><i class='bx bxl-youtube'></i></a>
                    <a href="https://www.instagram.com/proggaming_/" target="_blank"><i
                            class='bx bxl-instagram-alt'></i></a>
                </div>
            </div>

            <div class="container">
                <section id="home" class="page active">
                    <div class="blog">
                        <div class="welcome">
                            <img src="../avatares/prota.gif">
                            <span id="welcome"></span>
                        </div>
                        <div class="containerText">
                            <div class="conta">
                                <div style="display: flex; align-items: center;">
                                    <img id="user-avatar" src="../assets/avatars/avatar.jpg">
                                    <span id="perfil" class="span-perfil"></span>
                                </div>
                                <div>
                                    <span id="xp" style="color: orange;">XP: 0</span>
                                </div>
                                <button id="edit-profile-button">Editar Perfil</button>
                            </div>
                        </div>
                        <div class="containerText">
                            <div id="ranking-container">
                                <h2>üèÜ Top 10 Proggamers</h2>
                                <ul id="ranking-list">
                                </ul>
                            </div>
                        </div>
                        <div class="containerText">
                            <div class="section">
                                <img src="../logo-menor.png">
                                <div class="text-content">
                                    <h2>Lan√ßamento de Proggaming.</h2>
                                    <p>
                                        <span>Lan√ßamento da p√°gina de estudo sobre programa√ß√£o b√°sica de HTML, CSS e
                                            JS.
                                            Voc√™ ter√° aqui a possibilidade de aprender o b√°sico com minigames e li√ß√µes
                                            divertidas de fazer e ter conhecimento sobre o b√°sico do FrontEnd.
                                        </span>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="containerText">
                            <div
                                style="display: flex; flex-direction: column; align-items: center; text-align: center;">
                                <img src="../avatares/prota-login.gif"
                                    style="width: 70px; margin-bottom: 10px; border-radius: 50%; border: 2px solid #fffff034;">
                                <span style="font-family:'Roboto';">Quer ter o nosso site como um app? Instale e
                                    tenha
                                    ele
                                    mais f√°cil no seu
                                    dispositivo.</span>
                                <button id="btnInstalar" class="btn-app" style="margin-top: 10px;">
                                    <i class='bx bx-download'></i></button>
                            </div>
                        </div>
                        <div class="containerText">
                            <div
                                style="display: flex; flex-direction: column; align-items: center; text-align: center;">
                                <span style="font-family:  'Roboto';">
                                    Problemas, bugs ou d√∫vidas? Contate n√≥s:
                                    <p><span
                                            style="color: #008cff; font-weight: 900;">proggamingcontato@gmail.com</span>
                                    </p>
                                </span>
                            </div>
                        </div>
                        <div class="footer">
                            <span>&copy; 2025 by Proggaming, Inc.</span>
                        </div>
                </section>
                <section id="conteudo" class="page">
                    <h2>Bem-vindo!</h2>
                    <p>Escolha uma op√ß√£o no menu lateral.</p>
                </section>
            </div>
        </div>
    </main>
    <div>
        <div class="navbar-mobile">
            <a href="#/In√≠cio" onclick="mostrarSecao('home')"><i class='bx bx-home'></i></a>
            <a href="#/Aprender" onclick="carregarPagina('menu.html')"><i class='bx bx-book-open'></i></a>
            <a href="../Amigos/"><i class='bx bx-user-plus'></i></a>
            <a href=" #/Configura√ß√µes" onclick="carregarPagina('configuracoes.html')"><i class='bx bx-cog'></i></a>
            <button id="logoutBtnMobile" style="color: red;"><i class='bx bx-log-in'></i></button>
        </div>
    </div>

    <script src="script.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, orderBy, limit, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyClRHfJuTSogkbWLaaUKsSBGN1KiT5xuUc",
            authDomain: "proggamingpage.firebaseapp.com",
            projectId: "proggamingpage",
            storageBucket: "proggamingpage.firebasestorage.app",
            messagingSenderId: "911283259283",
            appId: "1:911283259283:web:0b9be83ed5e07391360a66",
            measurementId: "G-TQP4LNPYQ1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const perfilSpan = document.getElementById('perfil');
        const logoutBtnMobile = document.getElementById('logoutBtnMobile');
        const logoutBtn = document.getElementById('logoutBtn');
        const inputUsername = document.getElementById("novoUsername");
        const btnAlterarUsername = document.getElementById("btnAlterarUsername");
        const mensagemUsername = document.getElementById("mensagemUsername");
        const xpSpan = document.getElementById("xp");
        const welcomeText = document.getElementById("welcome");
        const editProfileButton = document.getElementById("edit-profile-button");
        const avatarModal = document.getElementById("avatar-modal");
        const closeButton = document.querySelector(".close-button");
        const avatarList = document.getElementById("avatar-list");
        const saveButton = document.getElementById("save-avatar-button");
        const userAvatar = document.getElementById("user-avatar");
        const rankingList = document.getElementById("ranking-list");

        const availableAvatars = [
            "../assets/avatars/avatar.jpg",
            "../assets/avatars/avatar2.jpg",
            "../assets/avatars/avatar3.jpg",
            "../assets/avatars/avatar4.jpg",
            "../assets/avatars/avatar5.jpg",
        ];

        let userDocRef;
        let selectedAvatarPath = "";

        function renderAvatars() {
            avatarList.innerHTML = '';
            availableAvatars.forEach(path => {
                const img = document.createElement("img");
                img.src = path;
                img.alt = "Avatar";
                img.classList.add("avatar-option");
                img.dataset.path = path;
                avatarList.appendChild(img);
            });
        }

        async function updateApelido(novoApelido) {
            if (!novoApelido) {
                mensagemUsername.style.color = "red";
                mensagemUsername.textContent = "Digite um apelido v√°lido!";
                return;
            }
            try {
                await updateDoc(userDocRef, { apelido: novoApelido });
                mensagemUsername.style.color = "green";
                mensagemUsername.textContent = "Apelido alterado com sucesso!";
                inputUsername.value = "";
            } catch (error) {
                mensagemUsername.style.color = "red";
                mensagemUsername.textContent = "Erro ao alterar: " + error.message;
                console.error(error);
            }
        }

        function setupEventListeners() {
            if (btnAlterarUsername) {
                btnAlterarUsername.addEventListener("click", () => updateApelido(inputUsername.value.trim()));
            }
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => signOut(auth).then(() => window.location.href = "../").catch(alert));
            }
            if (logoutBtnMobile) {
                logoutBtnMobile.addEventListener('click', () => signOut(auth).then(() => window.location.href = "../").catch(alert));
            }
            if (editProfileButton) {
                editProfileButton.addEventListener("click", () => {
                    renderAvatars();
                    avatarModal.style.display = "flex";
                    const currentAvatarPath = userAvatar.dataset.path;
                    selectedAvatarPath = currentAvatarPath;
                    document.querySelectorAll(".avatar-option").forEach(img => img.classList.remove("selected"));
                    const currentAvatar = document.querySelector(`.avatar-option[data-path="${currentAvatarPath}"]`);
                    if (currentAvatar) {
                        currentAvatar.classList.add("selected");
                    }
                });
            }
            if (closeButton) {
                closeButton.addEventListener("click", () => avatarModal.style.display = "none");
            }
            window.addEventListener("click", (event) => {
                if (event.target === avatarModal) {
                    avatarModal.style.display = "none";
                }
            });
            if (avatarList) {
                avatarList.addEventListener("click", (e) => {
                    if (e.target.classList.contains("avatar-option")) {
                        document.querySelectorAll(".avatar-option").forEach(img => img.classList.remove("selected"));
                        e.target.classList.add("selected");
                        selectedAvatarPath = e.target.dataset.path;
                    }
                });
            }
            if (saveButton) {
                saveButton.addEventListener("click", async () => {
                    if (!selectedAvatarPath) {
                        alert("Por favor, selecione um avatar!");
                        return;
                    }
                    if (userDocRef) {
                        try {
                            await updateDoc(userDocRef, { avatarUrl: selectedAvatarPath });
                            userAvatar.src = selectedAvatarPath;
                            userAvatar.dataset.path = selectedAvatarPath;
                            avatarModal.style.display = "none";
                        } catch (error) {
                            console.error("Erro ao salvar o avatar:", error);
                        }
                    }
                });
            }
        }

        function updateProfileUI(dados) {
            perfilSpan.innerText = dados.apelido || dados.email.split('@')[0];
            perfilSpan.dataset.email = dados.email;
            xpSpan.textContent = `XP: ${dados.xp || 0}`;
            const savedAvatarUrl = dados.avatarUrl || availableAvatars[0];
            userAvatar.src = savedAvatarUrl;
            userAvatar.dataset.path = savedAvatarUrl;
        }

        function renderRanking(querySnapshot) {
            rankingList.innerHTML = '';
            if (querySnapshot.empty) {
                rankingList.innerHTML = '<li>Nenhum dado de ranking encontrado.</li>';
                return;
            }
            querySnapshot.forEach((doc, index) => {
                const userData = doc.data();
                const rankingItem = document.createElement("li");

                const avatarSrc = userData.avatarUrl || '../assets/avatars/avatar.jpg';
                rankingItem.innerHTML = `
            <img src="${avatarSrc}" alt="Avatar do usu√°rio" class="ranking-avatar">
            <span class="ranking-nickname">${userData.apelido || userData.email}</span>
            <span class="ranking-xp">${userData.xp || 0} XP</span>
        `;
                rankingList.appendChild(rankingItem);
            });
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                welcomeText.textContent = `Ol√°, ${user.email} üëã`;

                userDocRef = doc(db, "usuarios", user.uid);

                onSnapshot(userDocRef, async (docSnap) => {
                    if (docSnap.exists()) {
                        updateProfileUI(docSnap.data());
                    } else {
                        const apelidoAleatorio = "user" + Math.floor(Math.random() * 10000);
                        const defaultAvatar = availableAvatars[0];
                        await setDoc(userDocRef, {
                            apelido: apelidoAleatorio,
                            email: user.email,
                            xp: 0,
                            avatarUrl: defaultAvatar
                        });
                        updateProfileUI({
                            apelido: apelidoAleatorio,
                            email: user.email,
                            xp: 0,
                            avatarUrl: defaultAvatar
                        });
                    }
                });

                perfilSpan.addEventListener('click', () => {
                    alert("Voc√™ est√° logado como:\n" + perfilSpan.dataset.email);
                });
                setupEventListeners();

                const rankingQuery = query(collection(db, "usuarios"), orderBy("xp", "desc"), limit(10));
                onSnapshot(rankingQuery, (snapshot) => {
                    console.log("Ranking atualizado!");
                    renderRanking(snapshot);
                });

            } else {
                window.location.href = "../";
            }
        });

        function mostrarSecao(id) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(id).classList.add('active');
        }

        function carregarPagina(url) {
            window.location.href = url;
        }

        window.addEventListener("DOMContentLoaded", () => {
            setTimeout(() => {
                document.body.classList.add("loaded");
                setTimeout(() => {
                    document.body.style.overflow = "auto";
                }, 300);
            }, 300);
        });

        let deferredPrompt;
        const btnInstalar = document.getElementById('btnInstalar');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            btnInstalar.style.display = 'block';
        });

        if (btnInstalar) {
            btnInstalar.addEventListener('click', (e) => {
                btnInstalar.style.display = 'none';
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('Usu√°rio aceitou a instala√ß√£o do PWA.');
                        } else {
                            console.log('Usu√°rio recusou a instala√ß√£o do PWA.');
                        }
                        deferredPrompt = null;
                    });
                }
            });
        }
    </script>
</body>

</html>