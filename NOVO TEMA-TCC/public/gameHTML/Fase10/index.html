<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
    <link rel="apple-touch-icon" href="./../icon_512x512.png">
    <link rel="icon" type="image/png" href="./../icon_512x512.png">
    <link rel="stylesheet" href="../TelaPrincipal/style.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <title>Proggaming | Fase 10 HTML</title>
</head>

<body>
    <div class="navbar">
        <button onclick="mostrarTela('bloco-teoria')">Teoria</button>
        <button onclick="mostrarTela('resultado')">Resultado</button>
        <button onclick="mostrarTela('editor-container')">Editor</button>
    </div>

    <div class="progresso">
        <div class="barra" id="barra-progresso"></div>
    </div>

    <div class="container-nivel">
        <div class="bloco-teoria">
            <div style="display: flex; flex-direction: row; align-items: center; justify-content: space-between;">
                <h3>Teoria - Fase 10</h3>
                <button class="botao-som" id="botao-som" onclick="toggleSom()">üîä</button>
            </div>
            <p id="texto-teoria"></p>
            <div id="extra-teoria" style="margin-top:10px; font-weight: 600; font-size:14px; color:#ddd;"></div>
            <h2 id="titulo-nivel">N√≠vel 1/6</h2>
            <p id="descricao-nivel">Inicie a estrutura b√°sica do projeto.</p>
            <hr>
            <span id="xp-total" style="font-family: 'Press Start 2P', cursive; font-weight: 600; color: #c7860e;">XP:
                0</span>
            <a href="../" style="float: right; margin: 10px;">
                <button class="voltar">
                    <i class='bx bx-arrow-back'></i>
                    <span style="font-size: 12px;">Voltar</span>
                </button>
            </a>
        </div>

        <div class="resultado" id="preview">A visualiza√ß√£o aparecer√° aqui.</div>

        <div class="editor-container">
            <div class="editor-header">
                <span class="dot red"></span>
                <span class="dot yellow"></span>
                <span class="dot green"></span>
                <span class="editor-title">index.html</span>
            </div>
            <textarea id="entrada-codigo" class="code-editor" spellcheck="false"
                placeholder="Digite o c√≥digo HTML aqui..." style="height: 90%;"></textarea>
            <button onclick="verificarNivel()">Testar C√≥digo</button>
        </div>
    </div>

    <audio id="audio-sucesso" src="../Green Screen + Efeito Sonoro (Acerto).mp3"></audio>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        let somAtivo = true;

        function toggleSom() {
            somAtivo = !somAtivo;
            const botaoSom = document.getElementById("botao-som");
            botaoSom.innerText = somAtivo ? "üîä" : "üîá";
        }

        // ====================================================
        // FUN√á√ïES AUXILIARES DE NORMALIZA√á√ÉO E LIMPEZA
        // ====================================================

        // 1. Fun√ß√£o de normaliza√ß√£o agressiva (Para Quizzes)
        function normalizeCode(code) {
            // Remove quebras de linha/tabula√ß√µes e substitui por um √∫nico espa√ßo
            let normalized = code.replace(/[\n\r\t]/g, ' ');
            // Remove espa√ßos extras ao redor de caracteres de sintaxe
            normalized = normalized.replace(/\s*([<>{}()\[\];:])\s*/g, '$1');
            // Substitui m√∫ltiplos espa√ßos por um √∫nico espa√ßo
            normalized = normalized.replace(/\s+/g, ' ');
            // Remove tags de c√≥digo/coment√°rio e espa√ßos no in√≠cio e no fim
            return normalized.trim().replace(/<\/?code>/ig, '').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"').replace(/&apos;/g, "'");
        }

        // 2. Fun√ß√£o de limpeza de c√≥digo (Para N√çVEIS DE C√ìDIGO) - OTIMIZADA PARA REMOVER ESPA√áOS ENTRE TAGS
        function cleanCodeForRegex(code) {
            // 1. Substitui quebras de linha/tabula√ß√µes por um √∫nico espa√ßo
            let cleaned = code.replace(/[\n\r\t]/g, ' ');
            // 2. Reduz m√∫ltiplos espa√ßos para um √∫nico espa√ßo
            cleaned = cleaned.replace(/\s{2,}/g, ' ');
            // 3. REMOVE TODOS OS ESPA√áOS ENTRE > e < (FOR√áA O C√ìDIGO PARA UMA LINHA √öNICA DE ESTRUTURA)
            cleaned = cleaned.replace(/>\s*</g, '><');
            // 4. Remove espa√ßos antes e depois do c√≥digo
            return cleaned.trim();
        }
        // ====================================================

        const firebaseConfig = {
            apiKey: "AIzaSyClRHfJuTSogkbWLaaUKsSBGN1KiT5xuUc",
            authDomain: "proggamingpage.firebaseapp.com",
            projectId: "proggamingpage",
            storageBucket: "proggamingpage.firebasestorage.app",
            messagingSenderId: "911283259283",
            appId: "1:911283259283:web:0b9be83ed5e07391360a66",
            measurementId: "G-TQP4LNPYQ1"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let userDocRef;
        let nivelAtual = 0;
        let xpTotal = 0;

        function mostrarTela(id) {
            document.querySelectorAll('.bloco-teoria, .resultado, .editor-container')
                .forEach(el => el.classList.remove('active'));
            document.querySelector('.' + id).classList.add('active');
        }
        mostrarTela('bloco-teoria');

        const entradaCodigo = document.getElementById("entrada-codigo");
        const preview = document.getElementById("preview");
        const barraProgresso = document.getElementById("barra-progresso");
        const extraTeoria = document.getElementById("extra-teoria");
        const xpSpan = document.getElementById("xp-total");

        // =================== FASE 10: PROJETO FINAL ===================
        const niveis = [
            {
                titulo: "N√≠vel 1/5 (Briefing)",
                descricao: "Seu projeto final √© criar um 'Portf√≥lio Pessoal'. Ele deve ter se√ß√µes para 'Sobre Mim', 'Projetos' e 'Contato'.",
                teoria: "Pense na estrutura sem√¢ntica que voc√™ vai usar para organizar o conte√∫do. O projeto ser√° constru√≠do passo a passo nos pr√≥ximos n√≠veis.",
                extra: "Objetivo: Criar um portf√≥lio pessoal simples e funcional usando tudo o que voc√™ aprendeu. Digite 'iniciar' para prosseguir.",
                respostaEsperada: /iniciar/i
            },
            {
                titulo: "N√≠vel 2/5 (Estrutura)",
                descricao: "Crie a estrutura b√°sica da sua p√°gina usando `<header>`, `<main>` e `<footer>`.",
                teoria: "A organiza√ß√£o sem√¢ntica √© a base do seu projeto. O `<header>` vai conter o t√≠tulo, o `<main>` o conte√∫do principal e o `<footer>` informa√ß√µes de contato.",
                extra: "Lembre-se da ordem: <code>&lt;header&gt; &lt;main&gt; &lt;footer&gt;</code>",
                respostaEsperada: /<header[^>]*>[\s\S]*<\/header>[\s\S]*<main[^>]*>[\s\S]*<\/main>[\s\S]*<footer[^>]*>[\s\S]*<\/footer>/i
            },
            {
                titulo: "N√≠vel 3/5 (Conte√∫do)",
                descricao: "Preencha a estrutura com t√≠tulos, par√°grafos e uma imagem.",
                teoria: "Dentro do `<main>`, adicione uma se√ß√£o 'Sobre Mim' com um `<h2>` e um `<p>`. Use uma imagem com o atributo `alt` para sua foto.",
                extra: "Estrutura esperada DENTRO de <main>: <code>&lt;h2&gt;...&lt;/h2&gt; &lt;p&gt;...&lt;/p&gt; &lt;img alt='...'&gt;</code>",
                respostaEsperada: /<main[^>]*>[\s\S]*<h2[^>]*>[\s\S]*<\/h2>[\s\S]*<p[^>]*>[\s\S]*<\/p>[\s\S]*<img[\s\S]*alt\s*=\s*['"][^'"]+['"][\s\S]*>[\s\S]*<\/main>/i
            },
            {
                titulo: "N√≠vel 4/5 (Links e Navega√ß√£o)",
                descricao: "Adicione navega√ß√£o com `<nav>` e pelo menos dois links (`<a>`) para as se√ß√µes. No rodap√©, inclua um link de e-mail (`mailto`).",
                teoria: "A tag `<nav>` √© ideal para menus e deve ficar dentro do `<header>`. O link de e-mail deve estar dentro do `<footer>`.",
                extra: "Exemplo: <code>&lt;nav&gt;&lt;a href='#'&gt;...&lt;/a&gt;&lt;a href='#'&gt;...&lt;/a&gt;&lt;/nav&gt;</code> e <code>&lt;footer&gt;&lt;a href='mailto:...'&gt;...&lt;/a&gt;&lt;/footer&gt;</code>",
                respostaEsperada: /<header[^>]*>[\s\S]*<nav[^>]*>[\s\S]*(<a[^>]*href\s*=\s*['"][^'"]*['"][^>]*>[\s\S]*<\/a>){2,}[\s\S]*<\/nav>[\s\S]*<\/header>[\s\S]*<footer[^>]*>[\s\S]*<a[^>]*href\s*=\s*['"]mailto:[^'"]*['"][^>]*>[\s\S]*<\/a>[\s\S]*<\/footer>/i
            },
            {
                titulo: "N√≠vel 5/5 (Boas Pr√°ticas e Valida√ß√£o)",
                descricao: "Revise todo o seu c√≥digo. Certifique-se de que ele tem um `<title>`, a tag `alt` nas imagens, e as tags essenciais. Seu c√≥digo deve ser completo!",
                teoria: "Um portf√≥lio completo deve ter as tags `<title>`, `<header>`, `<main>`, `<footer>` e `<img>` com o atributo `alt` para ser acess√≠vel e v√°lido.",
                extra: "O desafio √© garantir a presen√ßa de todas as tags principais.",
                respostaEsperada: /(?=[\s\S]*<title[^>]*>[\s\S]*<\/title>)(?=[\s\S]*<header[^>]*>)(?=[\s\S]*<main[^>]*>)(?=[\s\S]*<footer[^>]*>)(?=[\s\S]*<img[\s\S]*alt\s*=\s*['"][^'"]+['"])/i
            }
        ];

        auth.onAuthStateChanged(async user => {
            if (user) {
                userDocRef = db.collection("usuarios").doc(user.uid);
                const doc = await userDocRef.get();

                if (!doc.exists) {
                    alert("Usu√°rio n√£o encontrado!");
                    location.href = "../";
                    return;
                }

                const data = doc.data();

                if (!data.fasesHTML || data.fasesHTML.fase9?.status !== "concluida") {
                    alert("Voc√™ precisa concluir a Fase 9 antes!");
                    location.href = "../";
                    return;
                }

                if (data.fasesHTML?.fase10?.status === "concluida") {
                    alert("‚ö†Ô∏è Voc√™ j√° concluiu esta fase.");
                    window.location.href = "../";
                    return;
                }

                nivelAtual = data.fasesHTML?.fase10?.nivelAtual || 0;
                xpTotal = data.xp || 0;
                entradaCodigo.value = data.fasesHTML?.fase10?.codigoAtual || "";
                xpSpan.textContent = `XP: ${xpTotal}`;

                if (entradaCodigo.value) {
                    preview.innerHTML = entradaCodigo.value;
                }

                atualizarNivel();

                entradaCodigo.addEventListener("input", () => {
                    const input = entradaCodigo.value
                        .replace(/<script.*?>.*?<\/script>/gi, "")
                        .replace(/on\w+=".*?"/gi, "");
                    preview.innerHTML = input || "A visualiza√ß√£o aparecer√° aqui.";

                    userDocRef.update({
                        "fasesHTML.fase10.codigoAtual": entradaCodigo.value
                    });
                });
            } else {
                location.href = "./../";
            }
        });

        function verificarNivel() {
            const entradaOriginal = entradaCodigo.value;
            const audio = document.getElementById("audio-sucesso");

            let entradaParaTeste;

            // N√≠veis 1 (Briefing) e 5 (Valida√ß√£o) usam a normaliza√ß√£o agressiva.
            if (nivelAtual === 0 || nivelAtual === 4) {
                entradaParaTeste = normalizeCode(entradaOriginal);
            } else {
                // N√≠veis de 2 a 4 usam a limpeza OTIMIZADA para HTML.
                entradaParaTeste = cleanCodeForRegex(entradaOriginal);
            }

            const regex = niveis[nivelAtual].respostaEsperada;

            if (regex.test(entradaParaTeste)) {
                if (somAtivo) {
                    audio.play();
                }

                nivelAtual++;
                xpTotal += 10;
                xpSpan.textContent = `XP: ${xpTotal}`;

                userDocRef.update({
                    "fasesHTML.fase10.nivelAtual": nivelAtual,
                    "fasesHTML.fase10.codigoAtual": entradaCodigo.value,
                    xp: xpTotal
                });

                if (nivelAtual < niveis.length) {
                    atualizarNivel();
                } else {
                    concluirFase();
                }
            } else {
                alert("Resposta incorreta! Tente novamente.");
            }
        }

        function atualizarNivel() {
            if (nivelAtual >= niveis.length) return;
            const nivel = niveis[nivelAtual];
            document.getElementById("titulo-nivel").textContent = nivel.titulo;
            document.getElementById("descricao-nivel").textContent = nivel.descricao;
            document.getElementById("texto-teoria").textContent = nivel.teoria;
            extraTeoria.innerHTML = nivel.extra;
            entradaCodigo.value = "";
            preview.innerHTML = "A visualiza√ß√£o aparecer√° aqui.";
            barraProgresso.style.width = `${((nivelAtual + 1) / niveis.length) * 100}%`;
        }

        async function concluirFase() {
            try {
                await userDocRef.update({
                    "fasesHTML.fase10.status": "concluida",
                    "fasesHTML.fase10.codigoAtual": entradaCodigo.value,
                    "fasesHTML.fase10.nivelAtual": nivelAtual,
                    fase10Concluida: true,
                    xp: firebase.firestore.FieldValue.increment(60),
                    nivelAtual: firebase.firestore.FieldValue.increment(6)
                });

                document.querySelector(".resultado").innerHTML = `
                <h2>Parab√©ns!</h2>
                <p>Voc√™ concluiu a Fase 10 de HTML e todo o m√≥dulo! +60XP</p>
                <button onclick="location.href='../'">Finalizar M√≥dulo</button>
            `;
            } catch (e) {
                console.error("Erro ao salvar fase 10:", e);
                alert("Erro ao salvar progresso. Tente novamente!");
            }
        }
    </script>
</body>

</html>