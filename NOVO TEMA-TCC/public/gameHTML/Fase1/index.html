<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
  <link rel="apple-touch-icon" href="./../icon_512x512.png">
  <link rel="icon" type="image/png" href="./../icon_512x512.png">
  <link rel="stylesheet" href="../TelaPrincipal/style.css">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
  <title>Proggaming | Fase 1 HTML</title>
</head>

<body>
  <div class="navbar">
    <button onclick="mostrarTela('bloco-teoria')">Teoria</button>
    <button onclick="mostrarTela('resultado')">Resultado</button>
    <button onclick="mostrarTela('editor-container')">Editor</button>
  </div>

  <div class="progresso">
    <div class="barra" id="barra-progresso"></div>
  </div>

  <div class="container-nivel">
    <div class="bloco-teoria">
      <div style="display: flex; flex-direction: row; align-items: center; justify-content: space-between;">
        <h3>Teoria - Fase 1</h3>
        <button class="botao-som" id="botao-som" onclick="toggleSom()">üîä</button>
      </div>
      <p id="texto-teoria"></p>
      <div id="extra-teoria" style="margin-top:10px; font-weight: 600; font-size:14px; color:#ddd;"></div>
      <h2 id="titulo-nivel">N√≠vel 1/6</h2>
      <p id="descricao-nivel">Digite a tag HTML que representa um t√≠tulo principal.</p>
      <hr>
      <div style="margin: 10px 0px 10px 0px;">
        <span id="xp-total" style="font-family: 'Press Start 2P', cursive; font-weight: 600; color: #c7860e;">XP:
          0</span>
      </div>
      <a href="../" style="float: right; margin: 10px;">
        <button class="voltar">
          <i class='bx bx-arrow-back'></i>
          <span style="font-size: 12px;">Voltar</span>
        </button>
      </a>
    </div>

    <div class="resultado" id="preview">A visualiza√ß√£o aparecer√° aqui.</div>

    <div class="editor-container">
      <div class="editor-header">
        <span class="dot red"></span>
        <span class="dot yellow"></span>
        <span class="dot green"></span>
        <span class="editor-title">index.html</span>
      </div>
      <textarea id="entrada-codigo" class="code-editor" spellcheck="false" placeholder="Digite o c√≥digo HTML aqui..."
        style="height: 90%;"></textarea>
      <button onclick="verificarNivel()">Testar C√≥digo</button>
    </div>
  </div>

  <audio id="audio-sucesso" src="../Green Screen + Efeito Sonoro (Acerto).mp3"></audio>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script>
    let somAtivo = true;

    // ----------------------------------------------------
    // FUN√á√ÉO AUXILIAR DE NORMALIZA√á√ÉO
    // Adicionada para ignorar quebras de linha, tabula√ß√µes e excesso de espa√ßos
    // ----------------------------------------------------
    function normalizeCode(code) {
      // 1. Substitui todas as quebras de linha, tabula√ß√µes e retornos de carro por um √∫nico espa√ßo
      let normalized = code.replace(/[\n\r\t]/g, ' ');

      // 2. Remove espa√ßos extras ao redor de chaves e tags (crucial para o HTML)
      normalized = normalized.replace(/\s*([<>{}()\[\];:])\s*/g, '$1');

      // 3. Substitui m√∫ltiplos espa√ßos por um √∫nico espa√ßo
      normalized = normalized.replace(/\s+/g, ' ');

      // 4. Remove espa√ßos no in√≠cio e no fim da string
      return normalized.trim();
    }
    // ----------------------------------------------------


    function toggleSom() {
      somAtivo = !somAtivo;
      const botaoSom = document.getElementById("botao-som");
      botaoSom.innerText = somAtivo ? "üîä" : "üîá";
    }

    function mostrarTela(id) {
      document.querySelectorAll('.bloco-teoria, .resultado, .editor-container')
        .forEach(el => el.classList.remove('active'));

      document.querySelector('.' + id).classList.add('active');
    }

    mostrarTela('bloco-teoria');

    const firebaseConfig = {
      apiKey: "AIzaSyClRHfJuTSogkbWLaaUKsSBGN1KiT5xuUc",
      authDomain: "proggamingpage.firebaseapp.com",
      projectId: "proggamingpage",
      storageBucket: "proggamingpage.firebasestorage.app",
      messagingSenderId: "911283259283",
      appId: "1:911283259283:web:0b9be83ed5e07391360a66",
      measurementId: "G-TQP4LNPYQ1"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let nivelAtual = 0;
    let faseJaConcluida = false;

    const entradaCodigo = document.getElementById("entrada-codigo");
    const preview = document.getElementById("preview");
    const barraProgresso = document.getElementById("barra-progresso");
    const xpTotalSpan = document.getElementById("xp-total");
    const extraTeoria = document.getElementById("extra-teoria");

    const niveis = [
      {
        titulo: "N√≠vel 1/6",
        descricao: "Digite a tag HTML que representa um t√≠tulo principal. (Escreva o c√≥digo no editor)",
        teoria: "A tag <h1> √© usada para criar o t√≠tulo principal de uma p√°gina HTML. Os t√≠tulos v√£o de <h1> at√© <h6>, sendo <h1> o mais importante e <h6> o menos importante. √â uma boa pr√°tica usar apenas um <h1> por p√°gina, pois ele ajuda mecanismos de busca (SEO) e leitores de tela a entenderem a hierarquia do conte√∫do.",
        extra: "Exemplo: <code>&lt;h1&gt;Meu t√≠tulo&lt;/h1&gt;</code>",
        respostaEsperada: /<h1>.*<\/h1>/i
      },
      {
        titulo: "N√≠vel 2/6",
        descricao: "Use a tag para criar um par√°grafo com qualquer texto. (Escreva o c√≥digo no editor)",
        teoria: "A tag <p> define um par√°grafo em HTML. √â usada para agrupar blocos de texto. O navegador automaticamente adiciona um espa√ßo antes e depois de cada par√°grafo. Dentro de <p>, podem existir outras tags de texto, como <b>, <i> ou links <a>.",
        extra: "Exemplo: <code>&lt;p&gt;Ol√°, mundo!&lt;/p&gt;</code>",
        respostaEsperada: /<p>.*<\/p>/i
      },
      {
        titulo: "N√≠vel 3/6",
        descricao: "Use a tag de negrito para escrever 'Ol√° Mundo'. (Escreva o c√≥digo no editor)",
        teoria: "A tag <b> deixa o texto em negrito, mas apenas visualmente. Para dar √™nfase sem√¢ntica (quando o conte√∫do √© realmente importante), recomenda-se usar <strong>. J√° <b> √© mais usada para estiliza√ß√£o simples.",
        extra: "Exemplo: <code>&lt;b&gt;Ol√° Mundo&lt;/b&gt;</code>",
        respostaEsperada: /<b>\s*ol√° mundo\s*<\/b>/i
      },
      {
        titulo: "N√≠vel 4/6",
        descricao: "Insira um t√≠tulo de aba usando a tag correta. (Escreva o c√≥digo no editor)",
        teoria: "A tag <title> define o t√≠tulo que aparece na aba do navegador e nos resultados de pesquisa do Google. Essa tag deve ficar sempre dentro do <head>. √â importante escolher um t√≠tulo claro e objetivo, pois ajuda na experi√™ncia do usu√°rio e no SEO (otimiza√ß√£o para mecanismos de busca).",
        extra: "Exemplo: <code>&lt;title&gt;Minha P√°gina&lt;/title&gt;</code>",
        respostaEsperada: /<title>.*<\/title>/i
      },
      {
        titulo: "N√≠vel 5/6",
        descricao: "Use a tag <i> para deixar 'Importante' em it√°lico. (Escreva o c√≥digo no editor)",
        teoria: "A tag <i> deixa o texto em it√°lico, mas assim como <b>, √© apenas uma formata√ß√£o visual. Para dar √™nfase sem√¢ntica, recomenda-se usar <em> (√™nfase). A diferen√ßa √© que <em> comunica ao navegador e leitores de tela que o texto √© realmente importante.",
        extra: "Exemplo: <code>&lt;i&gt;Importante&lt;/i&gt;</code>",
        respostaEsperada: /<i>\s*importante\s*<\/i>/i
      },
      {
        titulo: "N√≠vel 6/6",
        descricao: "Monte a estrutura b√°sica com html, head e body. (Escreva o c√≥digo no editor)",
        teoria: "Todo documento HTML deve come√ßar com <!DOCTYPE html>, que informa ao navegador que o documento segue o padr√£o HTML5. Depois, temos a estrutura b√°sica:<html>: raiz do documento;<head>: cont√©m informa√ß√µes sobre a p√°gina (t√≠tulo, metadados, links de CSS, scripts);<body>: onde fica o conte√∫do vis√≠vel (textos, imagens, bot√µes, etc.). √â fundamental entender essa estrutura, pois todos os sites s√£o constru√≠dos a partir dela.",
        extra: "Exemplo:<br><code>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;&lt;/head&gt;<br>&lt;body&gt;&lt;/body&gt;<br>&lt;/html&gt;</code>",
        respostaEsperada: /<html>[\s\S]*<head>[\s\S]*<\/head>[\s\S]*<body>[\s\S]*<\/body>[\s\S]*<\/html>/i
      }
    ];


    auth.onAuthStateChanged(user => {
      if (!user) window.location.href = "./../";
      else carregarProgresso(user);
    });

    function carregarProgresso(user) {
      const ref = db.collection("usuarios").doc(user.uid);
      ref.get().then(docSnap => {
        if (docSnap.exists) {
          const data = docSnap.data();
          const xp = data.xp || 0;
          nivelAtual = data.nivelAtual || 0;
          faseJaConcluida = data.fase1Concluida || false;
          xpTotalSpan.textContent = `XP: ${xp}`;
          atualizarNivel();
          if (data.codigoAtual) {
            entradaCodigo.value = data.codigoAtual;
            preview.innerHTML = data.codigoAtual;
          }

          if (faseJaConcluida) {
            alert("‚ö†Ô∏è Voc√™ j√° concluiu esta fase.");
            history.back()
          }
        } else {
          atualizarNivel();
        }
      });
    }

    entradaCodigo.addEventListener("input", () => {
      const input = entradaCodigo.value
        .replace(/<script.*?>.*?<\/script>/gi, "")
        .replace(/on\w+=".*?"/gi, "");
      preview.innerHTML = input || "A visualiza√ß√£o aparecer√° aqui.";
      salvarCodigo(entradaCodigo.value);
    });

    function verificarNivel() {
      const entradaOriginal = entradaCodigo.value;
      // üö© APLICA√á√ÉO DA CORRE√á√ÉO: Normalizar a entrada do usu√°rio antes de testar
      const entradaNormalizada = normalizeCode(entradaOriginal);

      const audio = document.getElementById("audio-sucesso");
      const regex = niveis[nivelAtual].respostaEsperada;

      // Testar a entrada NORMALIZADA contra a regex
      if (regex.test(entradaNormalizada)) {
        if (somAtivo) {
          audio.play();
        }

        if (!faseJaConcluida) {
          adicionarXP(10);
        }

        nivelAtual++;
        salvarProgresso(nivelAtual);

        if (nivelAtual < niveis.length) {
          atualizarNivel();
        } else {
          document.querySelector(".resultado").innerHTML = `
                <h2>Parab√©ns!</h2>
                <p>Voc√™ concluiu a Fase 1 de HTML! ${faseJaConcluida ? "Pode refazer, mas n√£o ganhar√° XP extra." : "+60XP"}</p>
                <button onclick="concluirFase1()">Concluir a fase</button>
            `;
        }
      } else {
        alert("Resposta incorreta! Tente novamente.");
      }
    }

    function concluirFase1() {
      const user = auth.currentUser;
      if (!user) return;
      const ref = db.collection("usuarios").doc(user.uid);

      if (!faseJaConcluida) {
        ref.get().then(docSnap => {
          if (docSnap.exists) {
            const data = docSnap.data();
            const fases = data.fasesHTML || {};

            fases.fase1 = { status: "concluida" };
            fases.fase2 = { status: "disponivel" };

            ref.set({
              fasesHTML: fases,
              xp: firebase.firestore.FieldValue.increment(60),
              fase1Concluida: true
            }, { merge: true }).then(() => {
              faseJaConcluida = true;
              alert("‚úÖ Fase 1 conclu√≠da! Fase 2 desbloqueada.");
              window.location.href = "../";
            });
          }
        });
      } else {
        alert("‚ö†Ô∏è Voc√™ j√° concluiu esta fase. Pode revisar, mas n√£o ganha XP.");
        window.location.href = "../";
      }
    }

    function atualizarNivel() {
      if (nivelAtual >= niveis.length) return;
      const nivel = niveis[nivelAtual];
      document.getElementById("titulo-nivel").textContent = nivel.titulo;
      document.getElementById("descricao-nivel").textContent = nivel.descricao;
      document.getElementById("texto-teoria").textContent = nivel.teoria;
      extraTeoria.innerHTML = nivel.extra;
      entradaCodigo.value = "";
      preview.innerHTML = "A visualiza√ß√£o aparecer√° aqui.";
      barraProgresso.style.width = `${(nivelAtual / niveis.length) * 100}%`;
    }

    function adicionarXP(qtd) {
      const user = auth.currentUser;
      if (!user) return;
      const ref = db.collection("usuarios").doc(user.uid);
      db.runTransaction(async t => {
        const docSnap = await t.get(ref);
        const xpAtual = docSnap.exists ? (docSnap.data().xp || 0) : 0;
        t.set(ref, { xp: xpAtual + qtd }, { merge: true });
        xpTotalSpan.textContent = `XP: ${xpAtual + qtd}`;
      });
    }

    function salvarProgresso(nivel) {
      const user = auth.currentUser;
      if (!user) return;
      const ref = db.collection("usuarios").doc(user.uid);
      ref.set({ nivelAtual: nivel }, { merge: true });
    }

    function salvarCodigo(codigo) {
      const user = auth.currentUser;
      if (!user) return;
      const ref = db.collection("usuarios").doc(user.uid);
      ref.set({ codigoAtual: codigo }, { merge: true });
    }
  </script>
</body>

</html>