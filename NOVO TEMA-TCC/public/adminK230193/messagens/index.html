<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
    <link rel="stylesheet" href="../TelaPrincipal/style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <title>Proggaming | Painel Admin</title>
    <style>
        /* ==================== ESTILOS GERAIS (BODY E FUNDO) ==================== */
        body {
            /* Mantendo o fundo gradiente do seu tema */
            background: linear-gradient(120deg, #092b61, #09437a, #112a53);
            color: white;
            font-family: "Poppins", sans-serif;
            margin: 0;
            padding: 0;
            /* Seus cursores */
            cursor: url(./../PixelPointer.cur), auto;
            min-height: 100vh;
        }

        a,
        button {
            cursor: url(./../PixelSelector.cur), pointer !important;
        }

        /* ==================== ESTILOS ESPEC칈FICOS DO LOGIN ==================== */
        .login-container {
            max-width: 400px;
            /* Centraliza verticalmente e horizontalmente */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);

            padding: 30px;
            background: #073a69;
            /* Bloco de teoria */
            border: 2px solid #fffff072;
            /* Borda sutil */
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.7);
            /* Sombra mais forte */
        }

        .login-container h2 {
            font-family: 'Press Start 2P', cursive;
            margin-bottom: 25px;
            font-size: 16px;
            color: #c7860e;
            /* Cor de destaque (XP) */
        }

        .login-container input {
            width: calc(100% - 24px);
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #1A3D63;
            background: #092b61;
            /* Cor escura de fundo */
            color: #d4d4d4;
            /* Cor do texto no editor */
            border-radius: 4px;
            font-size: 16px;
            font-family: "Roboto", sans-serif;
        }

        .login-container input::placeholder {
            color: #aaa;
        }

        .login-container button {
            width: 100%;
            padding: 12px;
            /* Cor de Sucesso (Barra de Progresso) */
            background: linear-gradient(140deg, #4CAF50, #077010);
            border: none;
            color: white;
            font-family: 'Press Start 2P', cursive;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            transition: opacity 0.3s;
        }

        .login-container button:hover {
            opacity: 0.8;
        }

        #login-error-message {
            color: #ff5f56;
            /* Cor do ponto vermelho do editor */
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
        }


        /* ==================== ESTILOS DO DASHBOARD ==================== */
        .dashboard-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #073a69;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 30px;
            font-family: 'Press Start 2P', cursive;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: #1A3D63;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
        }

        .stat-card p {
            font-size: 36px;
            font-family: 'Press Start 2P', cursive;
            color: #c7860e;
            margin: 0;
        }

        /* Tabela de Usu치rios e Mensagens */
        .users-table-container,
        .messages-table-container {
            margin-top: 30px;
            overflow-x: auto;
            background: #092b61;
            padding: 15px;
            border-radius: 8px;
        }

        .users-table,
        .messages-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Roboto', sans-serif;
        }

        .users-table th,
        .users-table td,
        .messages-table th,
        .messages-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #1A3D63;
        }

        .users-table th,
        .messages-table th {
            background-color: #073a69;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            color: #ddd;
        }

        .users-table tr:hover,
        .messages-table tr:hover {
            background-color: #112a53;
        }
    </style>
</head>

<body>

    <div id="login-container" class="login-container">
        <h2>Acesso de Auditoria</h2>
        <input type="email" id="admin-email" placeholder="E-mail" value="" />
        <input type="password" id="admin-password" placeholder="Senha" />
        <button onclick="handleLogin()">Entrar</button>
        <p id="login-error-message"></p>
    </div>

    <div id="dashboard-content" class="dashboard-container" style="display: none;">
        <div class="dashboard-header">
            <h2>Painel de Controle 游늵</h2>
            <button onclick="auth.signOut()">
                <i class='bx bx-log-out'></i> Sair
            </button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total de Usu치rios Cadastrados</h3>
                <p id="total-users">...</p>
            </div>
            <div class="stat-card">
                <h3>Usu치rios Com XP > 100</h3>
                <p id="high-xp-users">...</p>
            </div>
            <div class="stat-card">
                <h3>游닎 Mensagens de Contato</h3>
                <p id="total-messages">...</p>
            </div>
        </div>

        <div class="users-table-container">
            <h3>Informa칞칫es Detalhadas dos Usu치rios</h3>
            <table class="users-table">
                <thead>
                    <tr>
                        <th>Apelido</th>
                        <th>XP Total</th>
                        <th>N칤vel</th>
                        <th>E-mail</th>
                        <th>UID</th>
                    </tr>
                </thead>
                <tbody id="users-data-body">
                </tbody>
            </table>
        </div>

        <div class="messages-table-container">
            <h3>Mensagens Recebidas (F칩rum/Contato)</h3>
            <table class="messages-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>E-mail</th>
                        <th>Mensagem</th>
                        <th>Data</th>
                    </tr>
                </thead>
                <tbody id="messages-data-body">
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // ========================================================
        // CONFIGURA칂츾O 칔NICA DO FIREBASE (PROJETO: banco-ionic-8bd53)
        // Esta configura칞칚o ser치 usada para Auth, Usu치rios e Mensagens.
        // ========================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDeoNFJC8hZHRCY3r5pTVP-QMhq4VxsYFM",
            authDomain: "banco-ionic-8bd53.firebaseapp.com",
            projectId: "banco-ionic-8bd53",
            storageBucket: "banco-ionic-8bd53.firebasestorage.app",
            messagingSenderId: "380034256776",
            appId: "1:380034256776:web:1fe4f6ca0a1204456e343d",
            measurementId: "G-4EVWERVFMQ"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // E-MAIL DE ADMINISTRADOR (CR칈TICO)
        const ADMIN_EMAIL = "proggamingcontato@gmail.com";

        // ========================================================
        // FUN칂츾O DE LOGIN
        // ========================================================
        async function handleLogin() {
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            const errorMsg = document.getElementById('login-error-message');

            errorMsg.textContent = '';

            if (email !== ADMIN_EMAIL) {
                errorMsg.textContent = "Erro: Acesso restrito ao e-mail de administrador.";
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                console.error("Erro completo do Firebase:", error);

                let message = "Erro de Login. Credenciais inv치lidas.";

                if (error.code === 'auth/wrong-password') {
                    message = "Senha incorreta. Verifique se a senha est치 correta no Firebase Auth.";
                } else if (error.code === 'auth/user-not-found') {
                    message = "Usu치rio n칚o encontrado. O e-mail n칚o est치 registrado no Firebase Auth.";
                } else if (error.code === 'auth/invalid-email') {
                    message = "E-mail com formato inv치lido.";
                }
                errorMsg.textContent = message;
            }
        }


        // ========================================================
        // CONTROLE DE ACESSO
        // ========================================================
        auth.onAuthStateChanged(user => {
            const loginContainer = document.getElementById('login-container');
            const dashboardContent = document.getElementById('dashboard-content');

            if (user) {
                if (user.email === ADMIN_EMAIL) {
                    loginContainer.style.display = 'none';
                    dashboardContent.style.display = 'block';
                    // Carrega os dois conjuntos de dados
                    carregarDadosAdmin();
                    carregarMensagens();
                } else {
                    alert("Acesso negado. Voc칡 n칚o tem permiss칚o de administrador.");
                    auth.signOut();
                    window.location.href = "./../";
                }
            } else {
                dashboardContent.style.display = 'none';
                loginContainer.style.display = 'block';
            }
        });

        // ========================================================
        // FUN칂칏ES DE CARREGAMENTO (USU츼RIOS: /usuarios)
        // ========================================================
        async function carregarDadosAdmin() {
            try {
                const usuariosRef = db.collection("usuarios");
                const snapshot = await usuariosRef.orderBy("xp", "desc").get();
                const usuarios = [];
                let highXpCount = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const xp = data.xp || 0;
                    if (xp > 100) {
                        highXpCount++;
                    }
                    usuarios.push({
                        uid: doc.id,
                        apelido: data.apelido || "N/A",
                        xp: xp,
                        nivel: data.nivelAtual || 0,
                        email: data.email || doc.id
                    });
                });

                document.getElementById('total-users').textContent = snapshot.size;
                document.getElementById('high-xp-users').textContent = highXpCount;

                preencherTabelaUsuarios(usuarios);

            } catch (error) {
                console.error("Erro ao carregar dados dos usu치rios:", error);
                // NOTA: Se isso falhar, cheque a permiss칚o de leitura total na cole칞칚o 'usuarios' nas Regras do Firestore.
            }
        }

        function preencherTabelaUsuarios(usuarios) {
            const tableBody = document.getElementById('users-data-body');
            tableBody.innerHTML = '';

            usuarios.forEach(user => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = user.apelido;
                row.insertCell().textContent = user.xp;
                row.insertCell().textContent = user.nivel;
                row.insertCell().textContent = user.email;
                row.insertCell().textContent = user.uid;
            });
        }

        // ========================================================
        // FUN칂츾O: CARREGAR MENSAGENS (MENSAGENS: /mensagens)
        // ========================================================
        async function carregarMensagens() {
            try {
                const mensagensRef = db.collection("mensagens");
                const snapshot = await mensagensRef.orderBy("timestamp", "desc").get();
                const mensagens = [];

                snapshot.forEach(doc => {
                    const data = doc.data();
                    mensagens.push({
                        name: data.name || "An칪nimo",
                        email: data.email || "Sem e-mail",
                        message: data.message || "(Vazio)",
                        timestamp: data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString('pt-BR') : 'N/A'
                    });
                });

                document.getElementById('total-messages').textContent = snapshot.size;

                preencherTabelaMensagens(mensagens);

            } catch (error) {
                console.error("Erro ao carregar mensagens:", error);
                // NOTA: Se isso falhar, cheque a permiss칚o de leitura total na cole칞칚o 'mensagens' nas Regras do Firestore.
            }
        }

        // ========================================================
        // FUN칂츾O: PREENCHER TABELA DE MENSAGENS
        // ========================================================
        function preencherTabelaMensagens(mensagens) {
            const tableBody = document.getElementById('messages-data-body');
            tableBody.innerHTML = '';

            mensagens.forEach(msg => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = msg.name;
                row.insertCell().textContent = msg.email;
                row.insertCell().textContent = msg.message.substring(0, 80) + (msg.message.length > 80 ? '...' : '');
                row.insertCell().textContent = msg.timestamp;
            });
        }
    </script>
</body>

</html>