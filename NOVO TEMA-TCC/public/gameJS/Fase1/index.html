<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
  <link rel="apple-touch-icon" href="./../icon_512x512.png">
  <link rel="icon" type="image/png" href="./../icon_512x512.png">
  <link rel="stylesheet" href="../TelaPrincipal/style.css">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
  <title>Proggaming | Fase 1 - JavaScript</title>
</head>

<body>
  <div class="progresso">
    <div class="barra" id="barra-progresso"></div>
  </div>

  <div class="container-nivel">
    <div class="bloco-teoria">
      <div class="teoria-header">
        <h3>Teoria - Fase 1</h3>
        <button class="botao-som" id="botao-som" onclick="toggleSom()" aria-label="Controle de som">üîä</button>
      </div>
      <p id="texto-teoria"></p>
      <div id="extra-teoria"></div>
      <button id="btn-extra-exemplo" class="btn-exemplo" onclick="toggleExemplo()">Exibir exemplo</button>

      <h2 id="titulo-nivel">N√≠vel 1/5</h2>
      <p id="descricao-nivel">JavaScript √© uma linguagem de programa√ß√£o essencial e a mais popular para o
        desenvolvimento web, respons√°vel por adicionar interatividade e dinamismo a p√°ginas web, como mapas interativos,
        anima√ß√µes e atualiza√ß√µes de conte√∫do em tempo real. Ele √© uma das tr√™s tecnologias fundamentais da web,
        juntamente com HTML (estrutura) e CSS (estilo)</p>

      <hr>

      <div class="xp-container">
        <span id="xp-total">XP: 0</span>
      </div>

      <a href="../index.html" class="voltar-link">
        <button class="btn-voltar">
          <i class='bx bx-arrow-back'></i>
          <span>Voltar</span>
        </button>
      </a>
    </div>

    <div class="resultado" id="preview">A visualiza√ß√£o aparecer√° aqui.</div>

    <div class="editor-container">
      <div class="editor-header">
        <span class="dot red"></span>
        <span class="dot yellow"></span>
        <span class="dot green"></span>
        <span class="editor-title">index.html</span>
      </div>
      <textarea id="entrada-codigo" class="code-editor" spellcheck="false"
        placeholder="Digite o c√≥digo JavaScript aqui..."></textarea>
      <button class="btn-testar" onclick="verificarNivel()">Testar C√≥digo</button>
    </div>
  </div>

  <nav class="navbar">
    <button onclick="mostrarTela('bloco-teoria')" class="nav-btn" aria-label="Ver teoria">
      <i class='bx bx-book'></i>
      <span>Teoria</span>
    </button>
    <button onclick="mostrarTela('resultado')" class="nav-btn" aria-label="Ver resultado">
      <i class='bx bx-show'></i>
      <span>Resultado</span>
    </button>
    <button onclick="mostrarTela('editor-container')" class="nav-btn" aria-label="Ver editor">
      <i class='bx bx-code-alt'></i>
      <span>Editor</span>
    </button>
  </nav>

  <audio id="audio-sucesso" src="../Green Screen + Efeito Sonoro (Acerto).mp3"></audio>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script>
    let somAtivo = true;
    let aguardandoAvanco = false;

    function toggleSom() {
      somAtivo = !somAtivo;
      const botaoSom = document.getElementById("botao-som");
      botaoSom.innerText = somAtivo ? "üîä" : "üîá";
    }

    function mostrarTela(id) {
      if (window.innerWidth > 1024) return;
      document.querySelectorAll('.bloco-teoria, .resultado, .editor-container').forEach(el => el.classList.remove('active'));
      const alvo = document.querySelector('.' + id);
      if (alvo) alvo.classList.add('active');
    }

    mostrarTela('bloco-teoria');

    const firebaseConfig = {
      apiKey: "AIzaSyClRHfJuTSogkbWLaaUKsSBGN1KiT5xuUc",
      authDomain: "proggamingpage.firebaseapp.com",
      projectId: "proggamingpage",
      storageBucket: "proggamingpage.firebasestorage.app",
      messagingSenderId: "911283259283",
      appId: "1:911283259283:web:0b9be83ed5e07391360a66",
      measurementId: "G-TQP4LNPYQ1"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let nivelJsAtual = 0;
    let fase1JsJaConcluida = false;
    let ultimoCodigoDigitado = "";

    const entradaCodigo = document.getElementById("entrada-codigo");
    const preview = document.getElementById("preview");
    const barraProgresso = document.getElementById("barra-progresso");
    const xpTotalSpan = document.getElementById("xp-total");
    const extraTeoria = document.getElementById("extra-teoria");
    const botaoExemplo = document.getElementById("btn-extra-exemplo");
    let extraVisivel = false;
    let extraHtmlAtual = "";

    const niveis = [
      {
        titulo: "N√≠vel 1/5",
        descricao: "JavaScript √© uma linguagem de programa√ß√£o essencial e a mais popular para o desenvolvimento web, respons√°vel por adicionar interatividade e dinamismo a p√°ginas web, como mapas interativos, anima√ß√µes e atualiza√ß√µes de conte√∫do em tempo real. Ele √© uma das tr√™s tecnologias fundamentais da web, juntamente com HTML (estrutura) e CSS (estilo)",
        teoria: "",
        extra: "",
        codigoInicial: "",
        respostaEsperada: "",
      },
      {
        titulo: "N√≠vel 2/5",
        descricao: "Declare uma vari√°vel chamada 'mensagem' e atribua a ela o valor 'Ol√°, mundo!'.",
        teoria: "Para armazenar dados com Javascript, ultilizamos uma estrutura chamada vari√°vel. Para declararmos uma variavel que tem como valor um texto, ultlizamos a declara√ß√£o let nomeDaVariavel = 'valor';<br> No exemplo, 'let' √© a palavra reservada que indica que estamos declarando uma vari√°vel, 'nomeDaVariavel' √© o nome que escolhemos para a vari√°vel (que deve seguir certas regras, como n√£o come√ßar com n√∫meros ou usar espa√ßos) e 'valor' √© o conte√∫do que estamos atribuindo √† vari√°vel, que no caso √© um texto (string) e por isso est√° entre aspas simples.",
        extra: "Exemplo: let texto = 'Ol√°, mundo!';",
        codigoInicial: "",
        respostaEsperada: /let\s+mensagem\s*=\s*'Ol√°, mundo!'\s*;?\s*/i
      },
      {
        titulo: "N√≠vel 3/5",
        descricao: "Use o metodo console.log para imprimir a vari√°vel mensagem",
        teoria: "O m√©todo console.log() √© usado para exibir mensagens no console do navegador, o que √© √∫til para depura√ß√£o e verifica√ß√£o de valores durante o desenvolvimento. Para imprimir o valor de uma vari√°vel, voc√™ simplesmente passa o nome da vari√°vel como argumento para console.log(). Por exemplo, se voc√™ tem uma vari√°vel chamada mensagem, voc√™ pode exibir seu valor no console com console.log(mensagem);",
        extra: "Exemplo: console.log(mensagem)",
        codigoInicial: "let mensagem = 'Ol√°, Mundo!'",
        respostaEsperada: /let\s+mensagem\s*=\s*['"][\s\S]*?['"]\s*;?\s*console\.log\(\s*mensagem\s*\)\s*;?/i
      },
      {
        titulo: "N√≠vel 4/5",
        descricao: "Transforme o comando console.log anterior em um coment√°rio.",
        teoria: "Para comentar um comando em JavaScript, basta adicionar // antes dele ou envolver com /* ... */. Isso faz com que o comando n√£o seja executado.",
        extra: "Exemplo: // console.log(mensagem) ou /* console.log(mensagem) */",
        codigoInicial: "let mensagem = 'Ol√°, Mundo!'<br>console.log(mensagem)",
        respostaEsperada: /(\/\/\s*console\.log\(.*\)|\/\*\s*console\.log\(.*\)\s*\*\/)/i
      },
      {
        titulo: "N√≠vel 5/5",
        descricao: "Utilize o m√©todo alert ou outro m√©todo da window para exibir uma mensagem.",
        teoria: "O objeto window representa a janela do navegador e possui v√°rios m√©todos √∫teis, como alert(), prompt(), confirm(), entre outros. O m√©todo alert exibe uma caixa de di√°logo com uma mensagem para o usu√°rio.",
        extra: "Exemplo: alert('Ol√°!') ou window.alert('Bem-vindo!')",
        codigoInicial: "",
        respostaEsperada: /(window\s*\.\s*alert\s*\(.*\)|alert\s*\(.*\))/i
      }
    ];

    auth.onAuthStateChanged(user => {
      if (!user) window.location.href = "./../";
      else carregarProgresso(user);
    });

    function carregarProgresso(user) {
      const ref = db.collection("usuarios").doc(user.uid);
      ref.get().then(docSnap => {
        if (docSnap.exists) {
          const data = docSnap.data();
          const xp = data.xp || 0;
          nivelJsAtual = (data.fasesJS && data.fasesJS.fase1 && Number.isInteger(data.fasesJS.fase1.nivelAtual)) ? data.fasesJS.fase1.nivelAtual : 0;
          fase1JsJaConcluida = (data.fasesJS && data.fasesJS.fase1 && data.fasesJS.fase1.status === "concluida") || false;
          const faseDoc = data.fasesJS && data.fasesJS.fase1 ? data.fasesJS.fase1 : {};
          if (fase1JsJaConcluida && ("codigoAtual" in faseDoc || "nivelAtual" in faseDoc)) {
            db.collection("usuarios").doc(user.uid).set({
              fasesJS: {
                fase1: {
                  codigoAtual: firebase.firestore.FieldValue.delete(),
                  nivelAtual: firebase.firestore.FieldValue.delete()
                }
              }
            }, { merge: true });
            nivelJsAtual = 0;
          }
          xpTotalSpan.textContent = `XP: ${xp}`;
          atualizarNivel();
          if (data.fasesJS && data.fasesJS.fase1 && data.fasesJS.fase1.codigoAtual) {
            entradaCodigo.value = data.fasesJS.fase1.codigoAtual;
            preview.innerHTML = data.fasesJS.fase1.codigoAtual;
          }
        } else {
          atualizarNivel();
        }
      });
    }

    function atualizarBotaoCorreto(estado) {
      const botao = document.querySelector('.btn-testar');
      if (estado === 'correto') {
        botao.style.background = '#2ecc40';
        botao.innerHTML = '<i class="bx bx-check"></i> Correto! Clique para avan√ßar';
      } else if (estado === 'incorreto') {
        botao.style.background = '#e74c3c';
        botao.innerHTML = '<i class="bx bx-x"></i> Tente novamente';
      } else {
        botao.style.background = '';
        botao.innerHTML = 'Testar C√≥digo';
      }
    }

    function avancarNivel() {
      aguardandoAvanco = false;
      atualizarBotaoCorreto();
      nivelJsAtual++;
      salvarProgresso(nivelJsAtual);
      if (nivelJsAtual < niveis.length) {
        atualizarNivel();
      } else {
        document.querySelector('.resultado').innerHTML = `
      <h2>Parab√©ns!</h2>
      <p>Voc√™ concluiu a Fase 1 de JavaScript! ${fase1JsJaConcluida ? "Pode refazer, mas n√£o ganhar√° XP extra." : "+50XP"}</p>
      <button onclick="concluirFase1()" class="btn-concluir">Concluir a fase</button>
    `;
      }
    }

    function mostrarVisualizacao(nivel, codigo) {
      const resultados = [];
      const logs = [];
      const errors = [];

      if (nivel === 3) {
        preview.innerHTML = "";
        return;
      }

      const fakeConsole = {
        log: (...args) => {
          try {
            logs.push(args.map(v => typeof v === 'object' ? JSON.stringify(v) : String(v)).join(' '));
          } catch (_) {
            logs.push(args.join(' '));
          }
        },
        info: (...args) => fakeConsole.log(...args),
        error: (...args) => {
          try {
            errors.push(args.map(v => typeof v === 'object' ? JSON.stringify(v) : String(v)).join(' '));
          } catch (_) {
            errors.push(args.join(' '));
          }
        }
      };

      const sanitizeDecls = (src) => {
        let out = src
          .replace(/\b(var|let|const)\s+([a-zA-Z_$][\w$]*)\s*=\s*/g, 'sandbox.$2 = ')
          .replace(/\b(var|let|const)\s+([a-zA-Z_$][\w$]*)\s*(;|\n|$)/g, 'sandbox.$2 = undefined$3');
        return out;
      };

      try {
        const sandbox = {};
        sandbox.alert = (...args) => {
          console.log(`alert bloqueado: ${args.join(' ')}`);
        };
        sandbox.prompt = () => "Simula√ß√£o de prompt";
        sandbox.confirm = () => true;
        sandbox.window = sandbox;
        const transformed = sanitizeDecls(String(codigo));

        try {
          const runAll = new Function('sandbox', 'console', `with(sandbox){ try{ ${transformed} }catch(e){ console.error('Exec error:', e && e.message ? e.message : String(e)); } return sandbox; }`);
          runAll(sandbox, fakeConsole);
        } catch (e) {
          errors.push(String(e && e.message ? e.message : e));
        }

        if (resultados.length === 0) {
          const porPontoEVirgula = String(codigo).split(';').map(s => s.trim()).filter(Boolean);
          for (const frag of porPontoEVirgula) {
            if (!frag) continue;
            if (/^(let|const|var|if|for|while|switch|function|class|try|catch|finally|return|break|continue)\b/.test(frag)) continue;
            try {
              const evalFrag = new Function('sandbox', 'console', `with(sandbox){ return (${frag}); }`);
              const val = evalFrag(sandbox, fakeConsole);
              if (val !== undefined) resultados.push({ linha: frag, valor: val });
            } catch (_) { }
          }
        }

        if (resultados.length === 0) {
          try {
            const evalAll = new Function('sandbox', 'console', `with(sandbox){ return (${String(codigo)}); }`);
            const valAll = evalAll(sandbox, fakeConsole);
            if (valAll !== undefined) resultados.push({ linha: '(bloco)', valor: valAll });
          } catch (_) { }
        }

        if (resultados.length === 0) {
          try {
            const chaves = Object.keys(sandbox || {});
            for (const k of chaves) {
              const v = sandbox[k];
              if (typeof v === 'number' || typeof v === 'boolean' || typeof v === 'string') {
                resultados.push({ linha: k, valor: v });
              }
            }
          } catch (_) { }
        }

      } catch (e) {
        errors.push(String(e && e.message ? e.message : e));
      }

      const partes = [];

      for (const l of logs) {
        partes.push(`<div class="output-log">console.log ‚Üí ${escapeHtml(String(l))}</div>`);
      }
      for (const er of errors) {
        partes.push(`<div class="output-error">Error ‚Üí ${escapeHtml(String(er))}</div>`);
      }
      for (const r of resultados) {
        const valorStr = formatValue(r.valor);
        partes.push(`<div class="output-result">${escapeHtml(String(r.linha))} => ${escapeHtml(valorStr)}</div>`);
      }

      preview.innerHTML = partes.length ? partes.join('') : "A visualiza√ß√£o aparecer√° aqui.";
      preview.scrollTop = preview.scrollHeight;

      function formatValue(v) {
        if (typeof v === 'string') return `"${v}"`;
        if (v === null) return 'null';
        if (v === undefined) return 'undefined';
        if (typeof v === 'object') {
          try { return JSON.stringify(v); } catch (_) { return String(v); }
        }
        return String(v);
      }
      function escapeHtml(str) {
        return (str + '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }
    }

    function verificarNivel() {
      const entrada = entradaCodigo.value;
      const audio = document.getElementById("audio-sucesso");
      const resposta = niveis[nivelJsAtual].respostaEsperada;

      if (aguardandoAvanco) {
        avancarNivel();
        return;
      }

      mostrarVisualizacao(nivelJsAtual, entrada);

      const passou = resposta instanceof RegExp ? resposta.test(entrada) : entrada === resposta;

      if (passou) {
        if (nivelJsAtual === 4) {
          try {
            const runReal = new Function(entrada);
            runReal();
          } catch (e) {
            console.error("Erro ao executar o alert real:", e);
          }
        }
        if (somAtivo) {
          audio.play();
        }
        if (!fase1JsJaConcluida) {
          adicionarXP(10);
        }
        salvarCodigo(entrada);
        aguardandoAvanco = true;
        atualizarBotaoCorreto('correto');
      } else {
        atualizarBotaoCorreto('incorreto');
        alert("Resposta incorreta! Tente novamente.");
      }
    }

    function concluirFase1() {
      const user = auth.currentUser;
      if (!user) return;
      const ref = db.collection("usuarios").doc(user.uid);

      if (!fase1JsJaConcluida) {
        ref.get().then(docSnap => {
          if (docSnap.exists) {
            const data = docSnap.data();
            const fases = data.fasesJS || {};

            fases.fase1 = { status: "concluida" };
            fases.fase2 = { status: "disponivel" };

            ref.set({
              fasesJS: fases,
              xp: firebase.firestore.FieldValue.increment(50)
            }, { merge: true }).then(() => {
              fase1JsJaConcluida = true;
              alert("‚úÖ Fase 1 conclu√≠da! Fase 2 desbloqueada.");
              window.location.href = "../index.html";
            });
          }
        });
      } else {
        alert("‚ö†Ô∏è Voc√™ j√° concluiu esta fase. Pode revisar, mas n√£o ganha XP.");
        window.location.href = "../index.html";
      }
    }

    function atualizarNivel() {
      if (nivelJsAtual >= niveis.length) return;
      const nivel = niveis[nivelJsAtual];
      document.getElementById("titulo-nivel").textContent = nivel.titulo;
      document.getElementById("descricao-nivel").textContent = nivel.descricao;
      document.getElementById("texto-teoria").textContent = nivel.teoria;

      let extra = nivel.extra;
      if (extra) {
        extra = extra.replace(/;\s*/g, ';<br>');
        extra = extra.replace(/(<br>\s*)+/g, '<br>');
      }
      extraHtmlAtual = extra || "";
      extraVisivel = false;
      extraTeoria.innerHTML = "";
      if (extraHtmlAtual) {
        botaoExemplo.style.display = 'inline-flex';
        botaoExemplo.innerText = 'Exibir exemplo';
      } else {
        botaoExemplo.style.display = 'none';
      }

      db.collection("usuarios").doc(auth.currentUser.uid).get().then(docSnap => {
        if (docSnap.exists) {
          const dados = docSnap.data();
          const codigoAtual = dados && dados.fasesJS && dados.fasesJS.fase1 && dados.fasesJS.fase1.codigoAtual;
          if (codigoAtual !== undefined && codigoAtual !== null) {
            entradaCodigo.value = codigoAtual;
            mostrarVisualizacao(nivelJsAtual, codigoAtual);
            return;
          }
        }

        if ((nivelJsAtual === 2 || nivelJsAtual === 3) && ultimoCodigoDigitado) {
          entradaCodigo.value = ultimoCodigoDigitado;
        } else {
          entradaCodigo.value = "";
        }
        preview.innerHTML = "A visualiza√ß√£o aparecer√° aqui.";
      });

      barraProgresso.style.width = `${(nivelJsAtual / niveis.length) * 100}%`;

      const resultado = document.querySelector('.resultado');
      if (nivelJsAtual === 0 || nivelJsAtual === 1) {
        resultado.style.display = 'none';
      } else {
        resultado.style.display = 'block';
      }
    }

    function adicionarXP(qtd) {
      const user = auth.currentUser;
      if (!user) return;
      const ref = db.collection("usuarios").doc(user.uid);
      db.runTransaction(async t => {
        const docSnap = await t.get(ref);
        const xpAtual = docSnap.exists ? (docSnap.data().xp || 0) : 0;
        t.set(ref, { xp: xpAtual + qtd }, { merge: true });
        xpTotalSpan.textContent = `XP: ${xpAtual + qtd}`;
      });
    }

    function toggleExemplo() {
      extraVisivel = !extraVisivel;
      extraTeoria.innerHTML = extraVisivel ? extraHtmlAtual : "";
      botaoExemplo.innerText = extraVisivel ? 'Ocultar exemplo' : 'Exibir exemplo';
    }

    function salvarProgresso(nivel) {
      const user = auth.currentUser;
      if (!user) return;
      const ref = db.collection("usuarios").doc(user.uid);
      ref.set({
        fasesJS: {
          fase1: {
            nivelAtual: nivel
          }
        }
      }, { merge: true });
    }

    function salvarCodigo(codigo) {
      const user = auth.currentUser;
      if (!user) return;
      ultimoCodigoDigitado = codigo;
      const ref = db.collection("usuarios").doc(user.uid);
      ref.set({
        fasesJS: {
          fase1: {
            codigoAtual: codigo
          }
        }
      }, { merge: true });
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>
    function mostrarConsoleReal() {
      if (window._erudaIniciado) {
        const preview = document.getElementById('preview');
        preview.innerHTML = '';
        eruda.destroy();
        window._erudaIniciado = false;
      }
      const preview = document.getElementById('preview');
      preview.innerHTML = '<div id="eruda-container" style="height:200px;"></div>';
      eruda.init({
        container: document.getElementById('eruda-container'),
        tool: ['console'],
        autoScale: true
      });
      window._erudaIniciado = true;
    }
  </script>
</body>

</html>