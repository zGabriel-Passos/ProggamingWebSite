<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
  <link rel="apple-touch-icon" href="./../icon_512x512.png">
  <link rel="icon" type="image/png" href="./../icon_512x512.png">
  <link rel="stylesheet" href="../TelaPrincipal/style.css">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
  <title>Proggaming | Fase 1 - JavaScript</title>
</head>

<body>
  <div class="navbar">
    <button onclick="mostrarTela('bloco-teoria')">Teoria</button>
    <button onclick="mostrarTela('resultado')">Resultado</button>
    <button onclick="mostrarTela('editor-container')">Editor</button>
  </div>

  <div class="progresso">
    <div class="barra" id="barra-progresso"></div>
  </div>

  <div class="container-nivel">
    <div class="bloco-teoria">
      <div style="display: flex; flex-direction: row; align-items: center; justify-content: space-between;">
        <h3>Teoria - Fase 1</h3>
        <button class="botao-som" id="botao-som" onclick="toggleSom()">üîä</button>
      </div>
      <p id="texto-teoria"></p>
      <div id="extra-teoria" style="margin-top:10px; font-weight: 600; font-size:14px; color:#ddd;"></div>
      <h2 id="titulo-nivel">N√≠vel 1/6</h2>
      <p id="descricao-nivel">JavaScript √© uma linguagem de programa√ß√£o essencial e a mais popular
        para o desenvolvimento web, respons√°vel por adicionar interatividade e dinamismo a p√°ginas web,
        como mapas interativos, anima√ß√µes e atualiza√ß√µes de conte√∫do em tempo real. Ele √© uma das tr√™s tecnologias
        fundamentais da web, juntamente com HTML (estrutura) e CSS (estilo)</p>
      <hr>
      <div style="margin: 10px 0px 10px 0px;">
        <span id="xp-total" style="font-family: 'Press Start 2P', cursive; font-weight: 600; color: #c7860e;">XP:
          0</span>
      </div>
      <a href="../" style="float: right; margin: 10px;">
        <button class="voltar">
          <i class='bx bx-arrow-back'></i>
          <span style="font-size: 12px;">Voltar</span>
        </button>
      </a>
    </div>

    <div class="resultado" id="preview">A visualiza√ß√£o aparecer√° aqui.</div>

    <div class="editor-container">
      <div class="editor-header">
        <span class="dot red"></span>
        <span class="dot yellow"></span>
        <span class="dot green"></span>
        <span class="editor-title">index.html</span>
      </div>
      <textarea id="entrada-codigo" class="code-editor" spellcheck="false" placeholder="Digite o c√≥digo HTML aqui..."
        style="height: 90%;"></textarea>
      <button onclick="verificarNivel()">Testar C√≥digo</button>
    </div>
  </div>

  <audio id="audio-sucesso" src="../Green Screen + Efeito Sonoro (Acerto).mp3"></audio>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script>
    let somAtivo = true;


    function toggleSom() {
      somAtivo = !somAtivo;
      const botaoSom = document.getElementById("botao-som");
      botaoSom.innerText = somAtivo ? "üîä" : "üîá";
    }

    function mostrarTela(id) {
      document.querySelectorAll('.bloco-teoria, .resultado, .editor-container')
        .forEach(el => el.classList.remove('active'));

      document.querySelector('.' + id).classList.add('active');
    }

    mostrarTela('bloco-teoria');

    const firebaseConfig = {
      apiKey: "AIzaSyClRHfJuTSogkbWLaaUKsSBGN1KiT5xuUc",
      authDomain: "proggamingpage.firebaseapp.com",
      projectId: "proggamingpage",
      storageBucket: "proggamingpage.firebasestorage.app",
      messagingSenderId: "911283259283",
      appId: "1:911283259283:web:0b9be83ed5e07391360a66",
      measurementId: "G-TQP4LNPYQ1"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let nivelJsAtual = 0;
    let fase1JsJaConcluida = false;

    const entradaCodigo = document.getElementById("entrada-codigo");
    const preview = document.getElementById("preview");
    const barraProgresso = document.getElementById("barra-progresso");
    const xpTotalSpan = document.getElementById("xp-total");
    const extraTeoria = document.getElementById("extra-teoria");

    const niveis = [
      {
        titulo: "N√≠vel 1/6",
        descricao: "JavaScript √© uma linguagem de programa√ß√£o essencial e a mais popular para o desenvolvimento web, respons√°vel por adicionar interatividade e dinamismo a p√°ginas web, como mapas interativos, anima√ß√µes e atualiza√ß√µes de conte√∫do em tempo real. Ele √© uma das tr√™s tecnologias fundamentais da web, juntamente com HTML (estrutura) e CSS (estilo)",
        teoria: "",
        extra: "",
        respostaEsperada: "",
      },
      {
        titulo: "N√≠vel 2/6",
        descricao: "Declare uma vari√°vel chamada 'mensagem' e atribua a ela o valor 'Ol√°, mundo!'.",
        teoria: "Para armazenar dados com Javascript, ultilizamos uma estrutura chamada vari√°vel. Para declararmos uma variavel que tem como valor um texto, ultlizamos a declara√ß√£o <code>let nomeDaVariavel = 'valor';<code><br> No exemplo, 'let' √© a palavra reservada que indica que estamos declarando uma vari√°vel, 'nomeDaVariavel' √© o nome que escolhemos para a vari√°vel (que deve seguir certas regras, como n√£o come√ßar com n√∫meros ou usar espa√ßos) e 'valor' √© o conte√∫do que estamos atribuindo √† vari√°vel, que no caso √© um texto (string) e por isso est√° entre aspas simples.",
        extra: "Exemplo: <code>&lt;p&gt;Ol√°, mundo!&lt;/p&gt;</code>",
        respostaEsperada: /let .* = 'Ol√° mundo!';/i
      },
      {
        titulo: "N√≠vel 3/6",
        descricao: "Crie uma variavel chamada mensagem e use o metodo console.log para imprimir-l√°",
        teoria: "O m√©todo <code>console.log()</code> √© usado para exibir mensagens no console do navegador, o que √© √∫til para depura√ß√£o e verifica√ß√£o de valores durante o desenvolvimento. Para imprimir o valor de uma vari√°vel, voc√™ simplesmente passa o nome da vari√°vel como argumento para <code>console.log()</code>. Por exemplo, se voc√™ tem uma vari√°vel chamada <code>mensagem</code>, voc√™ pode exibir seu valor no console com <code>console.log(mensagem);</code>.",
        extra: "Exemplo: <code>console.log(mensagem)</code>",
        respostaEsperada: /console\.log\(mensagem\)/i
      },
      {
        titulo: "N√≠vel 4/6",
        descricao: "Insira um t√≠tulo de aba usando a tag correta. (Escreva o c√≥digo no editor)",
        teoria: "A tag <title> define o t√≠tulo que aparece na aba do navegador e nos resultados de pesquisa do Google. Essa tag deve ficar sempre dentro do <head>. √â importante escolher um t√≠tulo claro e objetivo, pois ajuda na experi√™ncia do usu√°rio e no SEO (otimiza√ß√£o para mecanismos de busca).",
        extra: "Exemplo: <code>&lt;title&gt;Minha P√°gina&lt;/title&gt;</code>",
        respostaEsperada: /<title>.*<\/title>/i
      },
      {
        titulo: "N√≠vel 5/6",
        descricao: "Use a tag <i> para deixar 'Importante' em it√°lico. (Escreva o c√≥digo no editor)",
        teoria: "A tag <i> deixa o texto em it√°lico, mas assim como <b>, √© apenas uma formata√ß√£o visual. Para dar √™nfase sem√¢ntica, recomenda-se usar <em> (√™nfase). A diferen√ßa √© que <em> comunica ao navegador e leitores de tela que o texto √© realmente importante.",
        extra: "Exemplo: <code>&lt;i&gt;Importante&lt;/i&gt;</code>",
        respostaEsperada: /<i>\s*importante\s*<\/i>/i
      },
      {
        titulo: "N√≠vel 6/6",
        descricao: "Monte a estrutura b√°sica com html, head e body. (Escreva o c√≥digo no editor)",
        teoria: "Todo documento HTML deve come√ßar com <!DOCTYPE html>, que informa ao navegador que o documento segue o padr√£o HTML5. Depois, temos a estrutura b√°sica:<html>: raiz do documento;<head>: cont√©m informa√ß√µes sobre a p√°gina (t√≠tulo, metadados, links de CSS, scripts);<body>: onde fica o conte√∫do vis√≠vel (textos, imagens, bot√µes, etc.). √â fundamental entender essa estrutura, pois todos os sites s√£o constru√≠dos a partir dela.",
        extra: "Exemplo:<br><code>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;&lt;/head&gt;<br>&lt;body&gt;&lt;/body&gt;<br>&lt;/html&gt;</code>",
        respostaEsperada: /<html>[\s\S]*<head>[\s\S]*<\/head>[\s\S]*<body>[\s\S]*<\/body>[\s\S]*<\/html>/i
      }
    ];


    auth.onAuthStateChanged(user => {
      if (!user) window.location.href = "./../";
      else carregarProgresso(user);
    });

    function carregarProgresso(user) {
      const ref = db.collection("usuarios").doc(user.uid);
      ref.get().then(docSnap => {
        if (docSnap.exists) {
          const data = docSnap.data();
          const xp = data.xp || 0;
          nivelJsAtual = data.nivelJsAtual || 0;
          fase1JsJaConcluida = data.fase1JsConcluida || false;
          xpTotalSpan.textContent = `XP: ${xp}`;
          atualizarNivel();
          if (data.codigoJsAtual) {
            entradaCodigo.value = data.codigoJsAtual;
            preview.innerHTML = data.codigoJsAtual;
          }

          if (fase1JsJaConcluida) {
            alert("‚ö†Ô∏è Voc√™ j√° concluiu esta fase.");
            history.back()
          }
        } else {
          atualizarNivel();
        }
      });
    }

    entradaCodigo.addEventListener("input", () => {
      const input = entradaCodigo.value
        .replace(/<script.*?>.*?<\/script>/gi, "")
        .replace(/on\w+=".*?"/gi, "");
      preview.innerHTML = input || "A visualiza√ß√£o aparecer√° aqui.";
      salvarCodigo(entradaCodigo.value);
    });

    function verificarNivel() {
      const entrada = entradaCodigo.value;
      const audio = document.getElementById("audio-sucesso");
      const resposta = niveis[nivelJsAtual].respostaEsperada;

      // Corrige para aceitar regex e string
      const passou = resposta instanceof RegExp ? resposta.test(entrada) : entrada === resposta;

      if (passou) {
        if (somAtivo) {
          audio.play();
        }

        if (!fase1JsJaConcluida) {
          adicionarXP(10);
        }

        // Se est√° no n√≠vel 1, redireciona para a fase 2
        if (nivelJsAtual === 0) {
          window.location.href = "../Fase2/index.html";
          return;
        }

        nivelJsAtual++;
        salvarProgresso(nivelJsAtual);

        if (nivelJsAtual < niveis.length) {
          atualizarNivel();
        } else {
          document.querySelector(".resultado").innerHTML = `
        <h2>Parab√©ns!</h2>
        <p>Voc√™ concluiu a Fase 1 de HTML! ${fase1JsJaConcluida ? "Pode refazer, mas n√£o ganhar√° XP extra." : "+60XP"}</p>
        <button onclick="concluirFase1()">Concluir a fase</button>
      `;
        }
      } else {
        alert("Resposta incorreta! Tente novamente.");
      }
    }

    function concluirFase1() {
      const user = auth.currentUser;
      if (!user) return;
      const ref = db.collection("usuarios").doc(user.uid);

      if (!fase1JsJaConcluida) {
        ref.get().then(docSnap => {
          if (docSnap.exists) {
            const data = docSnap.data();
            const fases = data.fasesJS || {};

            fases.fase1 = { status: "concluida" };
            fases.fase2 = { status: "disponivel" };
            data.nivelJsAtual++;

            ref.set({
              fasesJS: fases,
              xp: firebase.firestore.FieldValue.increment(60),
              fase1JsConcluida: true
            }, { merge: true }).then(() => {
              fase1JsJaConcluida = true;
              alert("‚úÖ Fase 1 conclu√≠da! Fase 2 desbloqueada.");
              window.location.href = "../Fase2/index.html";
            });
          }
        });
      } else {
        alert("‚ö†Ô∏è Voc√™ j√° concluiu esta fase. Pode revisar, mas n√£o ganha XP.");
        window.location.href = "../";
      }
    }

    function atualizarNivel() {
      if (nivelJsAtual >= niveis.length) return;
      const nivel = niveis[nivelJsAtual];
      document.getElementById("titulo-nivel").textContent = nivel.titulo;
      document.getElementById("descricao-nivel").textContent = nivel.descricao;
      document.getElementById("texto-teoria").textContent = nivel.teoria;
      extraTeoria.innerHTML = nivel.extra;
      entradaCodigo.value = "";
      preview.innerHTML = "A visualiza√ß√£o aparecer√° aqui.";
      barraProgresso.style.width = `${(nivelJsAtual / niveis.length) * 100}%`;
    }

    function adicionarXP(qtd) {
      const user = auth.currentUser;
      if (!user) return;
      const ref = db.collection("usuarios").doc(user.uid);
      db.runTransaction(async t => {
        const docSnap = await t.get(ref);
        const xpAtual = docSnap.exists ? (docSnap.data().xp || 0) : 0;
        t.set(ref, { xp: xpAtual + qtd }, { merge: true });
        xpTotalSpan.textContent = `XP: ${xpAtual + qtd}`;
      });
    }

    function salvarProgresso(nivel) {
      const user = auth.currentUser;
      if (!user) return;
      const ref = db.collection("usuarios").doc(user.uid);
      ref.set({ nivelJsAtual: nivel }, { merge: true });
    }

    function salvarCodigo(codigo) {
      const user = auth.currentUser;
      if (!user) return;
      const ref = db.collection("usuarios").doc(user.uid);
      ref.set({ codigoJsAtual: codigo }, { merge: true });
    }
  </script>
</body>

</html>