<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
  <link rel="apple-touch-icon" href="./../icon_512x512.png">
  <link rel="icon" type="image/png" href="./../icon_512x512.png">
  <link rel="stylesheet" href="../TelaPrincipal/style.css">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
  <title>Proggaming | Fase 2 - JavaScript</title>
</head>

<body>
  <div class="navbar">
    <button onclick="mostrarTela('bloco-teoria')">Teoria</button>
    <button onclick="mostrarTela('resultado')">Resultado</button>
    <button onclick="mostrarTela('editor-container')">Editor</button>
  </div>

  <div class="progresso">
    <div class="barra" id="barra-progresso"></div>
  </div>

  <div class="container-nivel">
    <div class="bloco-teoria">
      <div style="display: flex; flex-direction: row; align-items: center; justify-content: space-between;">
        <h3>Teoria - Fase 2</h3>
        <button class="botao-som" id="botao-som" onclick="toggleSom()">üîä</button>
      </div>
      <p id="texto-teoria"></p>
      <div id="extra-teoria" style="margin-top:10px; font-weight: 600; font-size:14px; color:#ddd;"></div>
      <h2 id="titulo-nivel">N√≠vel 1/5</h2>
      <p id="descricao-nivel">Nesta fase voc√™ vai criar vari√°veis, trabalhar com tipos de dados e
        montar frases usando concatena√ß√£o e template literals.</p>
      <hr>
      <div style="margin: 10px 0px 10px 0px;">
        <span id="xp-total" style="font-family: 'Press Start 2P', cursive; font-weight: 600; color: #c7860e;">XP:
          0</span>
      </div>
      <a href="../index.html" style="float: right; margin: 10px;">
        <button class="voltar">
          <i class='bx bx-arrow-back'></i>
          <span style="font-size: 12px;">Voltar</span>
        </button>
      </a>
    </div>

    <div class="resultado" id="preview">A visualiza√ß√£o aparecer√° aqui.</div>

    <div class="editor-container">
      <div class="editor-header">
        <span class="dot red"></span>
        <span class="dot yellow"></span>
        <span class="dot green"></span>
        <span class="editor-title">index.html</span>
      </div>
      <textarea id="entrada-codigo" class="code-editor" spellcheck="false"
        placeholder="Digite o c√≥digo JavaScript aqui..." style="height: 90%;"></textarea>
      <button onclick="verificarNivel()">Testar C√≥digo</button>
    </div>
  </div>

  <audio id="audio-sucesso" src="../Green Screen + Efeito Sonoro (Acerto).mp3"></audio>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script>
    let somAtivo = true;
    let aguardandoAvanco = false;

    function toggleSom() {
      somAtivo = !somAtivo;
      const botaoSom = document.getElementById("botao-som");
      botaoSom.innerText = somAtivo ? "üîä" : "üîá";
    }

    function mostrarTela(id) {
      document.querySelectorAll('.bloco-teoria, .resultado, .editor-container')
        .forEach(el => el.classList.remove('active'));

      document.querySelector('.' + id).classList.add('active');
    }

    mostrarTela('bloco-teoria');

    const firebaseConfig = {
      apiKey: "AIzaSyClRHfJuTSogkbWLaaUKsSBGN1KiT5xuUc",
      authDomain: "proggamingpage.firebaseapp.com",
      projectId: "proggamingpage",
      storageBucket: "proggamingpage.firebasestorage.app",
      messagingSenderId: "911283259283",
      appId: "1:911283259283:web:0b9be83ed5e07391360a66",
      measurementId: "G-TQP4LNPYQ1"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let nivelJsAtual = 0;
    let fase2JaConcluida = false;

    const entradaCodigo = document.getElementById("entrada-codigo");
    const preview = document.getElementById("preview");
    const barraProgresso = document.getElementById("barra-progresso");
    const xpTotalSpan = document.getElementById("xp-total");
    const extraTeoria = document.getElementById("extra-teoria");

    const niveis = [
      {
        titulo: "N√≠vel 1/5",
        descricao: "Declare uma vari√°vel com var, outra com let e outra com const.",
        teoria: "var foi a forma original de declarar vari√°veis em JS e tem escopo de fun√ß√£o (vaza de blocos). let tem escopo de bloco e √© a escolha moderna para valores que mudam. const tamb√©m tem escopo de bloco e impede reatribui√ß√£o do identificador (o conte√∫do de objetos/arrays ainda pode ser mutado). Prefira let e const no dia a dia.",
        extra: "Exemplo: var a = 1; let b = 2; const c = 3;",
        codigoInicial: "",
        respostaEsperada: /(?=[\s\S]*\bvar\s+\w+\s*=)(?=[\s\S]*\blet\s+\w+\s*=)(?=[\s\S]*\bconst\s+\w+\s*=)[\s\S]*/i,
      },
      {
        titulo: "N√≠vel 2/5",
        descricao: "Crie uma string, um number e um boolean.",
        teoria: "Os principais tipos primitivos s√£o: string (texto entre aspas), number (inteiros e decimais sem distin√ß√£o) e boolean (true/false). Saber escolher o tipo correto evita bugs e facilita valida√ß√µes.",
        extra: "Ex.: let s = 'texto'; let n = 10; let b = true;",
        codigoInicial: "",
        respostaEsperada: /(?=[\s\S]*(let|var|const)\s+\w+\s*=\s*['\"]).*(?=[\s\S]*(let|var|const)\s+\w+\s*=\s*\d).*(?=[\s\S]*(let|var|const)\s+\w+\s*=\s*(true|false))[\s\S]*/i
      },
      {
        titulo: "N√≠vel 3/5",
        descricao: "Converta um valor com Number() e outro com String().",
        teoria: "Convers√µes expl√≠citas tornam seu c√≥digo previs√≠vel: Number(x) tenta transformar x em n√∫mero (retorna NaN se falhar). String(x) converte qualquer valor em texto. Evite confiar em coer√ß√£o impl√≠cita (ex.: == para n√£o gerar surpresas.",
        extra: "Ex.: let n = Number('42')<br>let s = String(42)",
        codigoInicial: "",
        respostaEsperada: /(?=[\s\S]*\bNumber\s*\()[\s\S]*\bString\s*\([\s\S]*/i
      },
      {
        titulo: "N√≠vel 4/5",
        descricao: "Fa√ßa uma frase juntando textos com + (concatena√ß√£o).",
        teoria: "Para juntar textos, use o operador + ou m√©todos como concat(). Aten√ß√£o: quando um operando √© string e o outro √© number, o + faz concatena√ß√£o, n√£o soma. Garanta o tipo correto antes de operar.",
        extra: "Ex.: let frase = 'Ol√°, ' + nome;",
        codigoInicial: "",
        respostaEsperada: /(?=[\s\S]*\+)(?=[\s\S]*['\"][^'\"]+['\"])[\s\S]*/i
      },
      {
        titulo: "N√≠vel 5/5",
        descricao: "Use template literals (crase) e ${} para interpolar.",
        teoria: "Template literals (entre crases) facilitam interpolar vari√°veis com ${} e quebrar linhas sem escapes. S√£o ideais para montar mensagens leg√≠veis e reduzir erros de concatena√ß√£o.",
        extra: "Ex.: let msg = `Ol√°, ${nome}!`",
        codigoInicial: "",
        respostaEsperada: /`[\s\S]*`/i
      }
    ];


    auth.onAuthStateChanged(user => {
      if (!user) window.location.href = "./../";
      else carregarProgresso(user);
    });

    function carregarProgresso(user) {
      const ref = db.collection("usuarios").doc(user.uid);
      ref.get().then(docSnap => {
        if (docSnap.exists) {
          const data = docSnap.data();
          const xp = data.xp || 0;
          nivelJsAtual = (data.fasesJS && data.fasesJS.fase2 && Number.isInteger(data.fasesJS.fase2.nivelAtual)) ? data.fasesJS.fase2.nivelAtual : 0;
          fase2JaConcluida = (data.fasesJS && data.fasesJS.fase2 && data.fasesJS.fase2.status === "concluida") || false;
          xpTotalSpan.textContent = `XP: ${xp}`;
          atualizarNivel();
          if (data.fasesJS && data.fasesJS.fase2 && data.fasesJS.fase2.codigoAtual) {
            entradaCodigo.value = data.fasesJS.fase2.codigoAtual;
            preview.innerHTML = data.fasesJS.fase2.codigoAtual;
          }

          if (fase2JaConcluida) {
            alert("‚ö†Ô∏è Voc√™ j√° concluiu esta fase.");
            history.back()
          }
        } else {
          atualizarNivel();
        }
      });
    }

    function atualizarBotaoCorreto(estado) {
      const botao = document.querySelector('.editor-container button');
      if (estado === 'correto') {
        botao.style.background = '#2ecc40';
        botao.innerHTML = '<i class="bx bx-check"></i> Correto! Clique para avan√ßar';
      } else if (estado === 'incorreto') {
        botao.style.background = '#e74c3c';
        botao.innerHTML = '<i class="bx bx-x"></i> Tente novamente';
      } else {
        botao.style.background = '';
        botao.innerHTML = 'Testar C√≥digo';
      }
    }

    function avancarNivel() {
      aguardandoAvanco = false;
      atualizarBotaoCorreto();
      nivelJsAtual++;
      salvarProgresso(nivelJsAtual);
      if (nivelJsAtual < niveis.length) {
        atualizarNivel();
      } else {
        document.querySelector('.resultado').innerHTML = `
      <h2>Parab√©ns!</h2>
      <p>Voc√™ concluiu a Fase 2 de JavaScript! ${fase2JaConcluida ? "Pode refazer, mas n√£o ganhar√° XP extra." : "+50XP"}</p>
      <button onclick="concluirFase()">Concluir a fase</button>
    `;
      }
    }

    function atualizarNivel() {
      if (nivelJsAtual >= niveis.length) return;
      const nivel = niveis[nivelJsAtual];
      document.getElementById("titulo-nivel").textContent = nivel.titulo;
      document.getElementById("descricao-nivel").textContent = nivel.descricao;
      document.getElementById("texto-teoria").textContent = nivel.teoria;

      let extra = nivel.extra;
      if (extra) {
        extra = extra.replace(/;\s*/g, ';<br>');
        extra = extra.replace(/(<br>\s*){2,}/g, '<br>');
      }
      extraTeoria.innerHTML = extra;

      db.collection("usuarios").doc(auth.currentUser.uid).get().then(docSnap => {
        if (docSnap.exists) {
          const dados = docSnap.data();
          const codigoAtual = dados && dados.fasesJS && dados.fasesJS.fase2 && dados.fasesJS.fase2.codigoAtual;
          if (codigoAtual !== undefined && codigoAtual !== null) {
            entradaCodigo.value = codigoAtual;
            mostrarVisualizacao(nivelJsAtual, codigoAtual);
            return;
          }
        }
        entradaCodigo.value = "";
        preview.innerHTML = "A visualiza√ß√£o aparecer√° aqui.";
      });

      barraProgresso.style.width = `${(nivelJsAtual / niveis.length) * 100}%`;

      const resultado = document.querySelector('.resultado');
      if (nivelJsAtual === 0 || nivelJsAtual === 1) {
        resultado.style.display = 'none';
      } else {
        resultado.style.display = 'block';
      }
    }

    function mostrarVisualizacao(nivel, codigo) {
      if (nivel === 4) {
        let output = "";
        const originalConsoleLog = console.log;
        console.log = function (...args) {
          output += args.join(" ") + "<br>";
        };
        try {
          eval(codigo);
        } catch (e) {
          output += `<span style="color:red;">${e}</span>`;
        }
        console.log = originalConsoleLog;
        preview.innerHTML = output || "Nenhum resultado.";
      } else {
        preview.innerHTML = "A visualiza√ß√£o aparecer√° aqui.";
      }
    }

    function verificarNivel() {
      const entrada = entradaCodigo.value;
      const audio = document.getElementById("audio-sucesso");
      const resposta = niveis[nivelJsAtual].respostaEsperada;
      const botao = document.querySelector('.editor-container button');

      if (aguardandoAvanco) {
        avancarNivel();
        return;
      }

      mostrarVisualizacao(nivelJsAtual, entrada);

      if (nivelJsAtual === 2 || nivelJsAtual === 3 || nivelJsAtual === 4) {
        mostrarConsoleReal();
        setTimeout(() => {
          if (window.eruda && eruda._devTools && eruda._devTools._tools.console) {
            eruda._devTools._tools.console.clear();
          }
          try {
            eval(entrada);
          } catch (e) {
            if (window.eruda && eruda._devTools && eruda._devTools._tools.console) {
              eruda._devTools._tools.console.error(e);
            }
          }
        }, 100);
      }

      const passou = resposta instanceof RegExp ? resposta.test(entrada) : entrada === resposta;

      if (passou) {
        if (somAtivo) {
          audio.play();
        }
        if (!fase2JaConcluida) {
          adicionarXP(10);
        }
        salvarCodigo(entrada);
        aguardandoAvanco = true;
        atualizarBotaoCorreto('correto');
      } else {
        atualizarBotaoCorreto('incorreto');
        alert("Resposta incorreta! Tente novamente.");
      }
    }

    function concluirFase() {
      const user = auth.currentUser;
      if (!user) return;
      const ref = db.collection("usuarios").doc(user.uid);

      if (!fase2JaConcluida) {
        ref.get().then(docSnap => {
          if (docSnap.exists) {
            const data = docSnap.data();
            const fases = data.fasesJS || {};

            fases.fase2 = { status: "concluida" };
            fases.fase3 = fases.fase3 || { status: "disponivel" };
            data.nivelJsAtual++;

            ref.set({
              fasesJS: fases,
              xp: firebase.firestore.FieldValue.increment(50)
            }, { merge: true }).then(() => {
              fase2JaConcluida = true;
              alert("‚úÖ Fase 2 conclu√≠da! Fase 3 desbloqueada.");
              window.location.href = "../index.html";
            });
          }
        });
      } else {
        alert("‚ö†Ô∏è Voc√™ j√° concluiu esta fase. Pode revisar, mas n√£o ganha XP.");
        window.location.href = "../index.html";
      }
    }

    function adicionarXP(qtd) {
      const user = auth.currentUser;
      if (!user) return;
      const ref = db.collection("usuarios").doc(user.uid);
      db.runTransaction(async t => {
        const docSnap = await t.get(ref);
        const xpAtual = docSnap.exists ? (docSnap.data().xp || 0) : 0;
        t.set(ref, { xp: xpAtual + qtd }, { merge: true });
        xpTotalSpan.textContent = `XP: ${xpAtual + qtd}`;
      });
    }

    function salvarProgresso(nivel) {
      const user = auth.currentUser;
      if (!user) return;
      const ref = db.collection("usuarios").doc(user.uid);
      ref.set({
        fasesJS: {
          fase2: {
            nivelAtual: nivel
          }
        }
      }, { merge: true });
    }

    function salvarCodigo(codigo) {
      const user = auth.currentUser;
      if (!user) return;
      const ref = db.collection("usuarios").doc(user.uid);
      ref.set({
        fasesJS: {
          fase2: {
            codigoAtual: codigo
          }
        }
      }, { merge: true });
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>
    function mostrarConsoleReal() {
      if (window._erudaIniciado) {
        const preview = document.getElementById('preview');
        preview.innerHTML = '';
        eruda.destroy();
        window._erudaIniciado = false;
      }
      const preview = document.getElementById('preview');
      preview.innerHTML = '<div id="eruda-container" style="height:200px;"></div>';
      eruda.init({
        container: document.getElementById('eruda-container'),
        tool: ['console'],
        autoScale: true
      });
      window._erudaIniciado = true;
    }
  </script>
</body>

</html>